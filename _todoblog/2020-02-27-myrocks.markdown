---
layout: post
title: MyRocksä»0åˆ°1
date: 2020-02-27 10:51
categories:
  - MyRocks
typora-root-url: ../../layamon.github.io
---
* TOC
{:toc}
> æœ¬æ–‡ç±»ä¼¼äºä¸€ä¸ªæ‚ä¹±çš„ç¬”è®°ï¼Œè®°å½•è®¤è¯†myrocksè¿‡ç¨‹ä¸­çš„é—®é¢˜

åœ¨[from btree to lsm-tree](http://liuyangming.tech/12-2019/leveldb.html)ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°å†™B+-treeæ—¶ï¼Œå†™ä¸€æ¡è®°å½•å°±æ„å‘³ç€å†™ä¸€ä¸ªé¡µï¼›ä¸è€ƒè™‘bufferpoolçš„åˆå¹¶å†™å’Œdwbufferçš„å†™æ”¾å¤§ï¼Œåœ¨InnoDBä¸­ï¼Œå¦‚æœä¸šåŠ¡è´Ÿè½½éšæœºå†™Næ¡è®°å½•ï¼Œæœ€åçš„æƒ…å†µä¸‹ï¼Œå°±æ„å‘³ç€è¦å†™Nä¸ªé¡µï¼›è¿™å¸¦æ¥å¾ˆå¤§çš„**å†™æ”¾å¤§**ã€‚å¦å¤–ï¼Œæ¯ä¸ªé¡µä¸­éƒ½æœ‰ä¸€äº›ç¢ç‰‡ç©ºé—´ï¼Œè¿™äº›æ— ç”¨ç©ºé—´ä¼šæµªè´¹IOå¸¦å®½ï¼Œè€Œé’ˆå¯¹è¿™ä¸ªï¼ŒInnoDBä¸­è®¾è®¡äº†Compressed Pageï¼›Compressed PageåŒæ ·æ˜¯è¦å¯¹é½å­˜å‚¨ï¼ˆ0~4kbå¯¹é½åˆ°4kbï¼Œ4~8kbå¯¹é½åˆ°8kbï¼Œ8~16kbå¯¹é½åˆ°16kbï¼‰ï¼Œåªè¦å¯¹é½å°±ä¼šå­˜åœ¨ç©ºé—²ç©ºé—´ã€‚è¿™åˆå¸¦æ¥äº†**ç©ºé—´æ”¾å¤§**ã€‚

åŸºäºB+-treeçš„å¼Šç«¯ä»¥åŠç›®å‰å­˜å‚¨ä»‹è´¨çš„æ¼”åŒ–ï¼ˆHDD->SSDï¼Œiopsæ›´å¿«ï¼Œä½†æ˜¯å¦‚æœæ¯æ¬¡å†™çš„æ”¾å¤§ä¸¥é‡ï¼Œé‚£ä¹ˆä¼šæµªè´¹ssdçš„å†™æ€§èƒ½ï¼Ÿï¼‰ï¼Œæ•°æ®åº“å­˜å‚¨å¼•æ“ä¹Ÿå‡ºç°äº†å˜é©ã€‚å…¶ä¸­LSM-treeç›®å‰è·å¾—äº†å¾ˆå¤šç›®å…‰ï¼ŒMySQLä¸­ä¹Ÿå¯ä»¥é›†æˆLSM-treeæ¶æ„çš„å­˜å‚¨å¼•æ“â€”â€”RocksDBï¼Œå«MyRocksã€‚æœ¬æ–‡æ˜¯ä½œè€…å¯¹MyRockså­¦ä¹ çš„æ€»ç»“ï¼Œä¹Ÿä¼šä¸æ–­åœ¨æ­¤æ›´æ–°æ–°çš„è®¤è¯†ï¼Œå¸Œæœ›å¯¹æƒ³äº†è§£è¿™ä¸ªäº§å“çš„åŒå­¦æœ‰æ‰€å¸®åŠ©ã€‚

> è¿™é‡Œå…³äºç¡¬ä»¶è®¾å¤‡ï¼Œææ˜ç™½å‡ ä¸ªæ¦‚å¿µï¼š**ç”µæ°”æ¥å£**ã€**å­˜å‚¨åè®®**ã€**å­˜å‚¨ä»‹è´¨**ã€‚
>
> å½“æˆ‘ä»¬æœ‰ä¸€ä¸ªä¸»æœºï¼Œç°åœ¨è¦æ¥å…¥å¤–æ¥è®¾å¤‡ï¼Œè®¾å¤‡è¦æ’åˆ°ä¸»æ¿ä¸Šï¼Œéœ€è¦è¯¥è®¾å¤‡èƒ½å¤Ÿæ»¡è¶³ä¸»æ¿ä¸Šçš„**ç”µæ°”æ¥å£ï¼ˆæ€»çº¿è§„èŒƒï¼‰**ï¼›æ’ä¸Šå»åï¼Œæ“ä½œç³»ç»Ÿä¸Šå®‰è£…ç›¸åº”è®¾å¤‡çš„é©±åŠ¨ï¼Œé©±åŠ¨ä¸­æœ‰è®¾å¤‡çš„**å­˜å‚¨åè®®**ï¼›ä¹‹åçš„IOå°±å°è£…æˆç›¸åº”å­˜å‚¨åè®®çš„å‘½ä»¤ï¼Œå†™åˆ°å¤–å­˜çš„**å­˜å‚¨ä»‹è´¨**ä¸Šå»ã€‚ç”µæ°”æ¥å£ä¸»è¦æœ‰SATAã€SASã€PCIeï¼›å­˜å‚¨åè®®æœ‰AHCIã€SCSIã€NVMeï¼›å­˜å‚¨ä»‹è´¨æœ‰NANDã€3D-Xpointã€‚
>
> ![image-20200227141415425](/image/2020-0227-nand.png)

# RocksDB

RocksDbæ˜¯ä¸€ä¸ªå¤šç‰ˆæœ¬çš„KVå­˜å‚¨å¼•æ“ï¼ˆversioned key-value storeï¼‰ï¼›ç›¸æ¯”äºä¼ ç»Ÿæ•°æ®åº“ä»¥å—ä¸ºæœ€å°å•ä½è¿›è¡ŒIOå­˜å‚¨ï¼ŒRocksDBå¯æ›´ç»†ç²’åº¦çš„å­˜å‚¨ï¼Œå¯è®¤ä¸ºæœ€å°çš„ç²’åº¦æ˜¯kv pairï¼ˆ`(userkey,seq,type) => uservalue`ï¼‰ï¼›

ä¸‹å›¾ä¸­çœå»äº†Indexã€BloomFilterã€Block Cacheå’ŒColumn Familyï¼ˆä¸‹ç§°CFï¼‰çš„æ¦‚å¿µï¼Œæè¿°äº†RocksDBçš„è¯»å†™è·¯å¾„ï¼š

> é€šè¿‡CFå°†(k,v)è¿›è¡Œäº†é€»è¾‘ä¸Šçš„åˆ†åŒºï¼Œè¿™æ ·ä¸åŒåˆ†åŒºå¯ä»¥åˆ†åˆ«å†™è‡ªå·±çš„MemTableå’ŒSSTTableï¼Œä½†æ˜¯å…±äº«åŒä¸€ä¸ªWALï¼›ä½†æ˜¯RocksDBä¿è¯**è·¨CFçš„çš„åŸå­å†™**å’Œ**ä¸€è‡´æ€§è¯»**å¿«ç…§ï¼Œä»¥åŠå¯ä»¥åˆ†åˆ«å¯¹ä¸åŒCFè¿›è¡ŒæŒ‚è½½ã€åˆ é™¤ä¸é…ç½®ã€‚

![image-20200227180548341](/image/2020-0227-rocksdb-overview.png)

åœ¨RocksDBä¸­ï¼Œå†™äº‹åŠ¡æäº¤æ—¶åªéœ€è¦ä¿è¯Log Recordè½ç›˜å³å¯ï¼ŒDataåªéœ€è¦å¤åˆ¶åˆ°Active MemTableä¸­ï¼Œåç»­çš„æ•°æ®è½ç›˜ç”±FLush/Compactæ“ä½œè¿›è¡Œã€‚

ç›¸æ¯”äºB+-treeåœ¨å†™æ”¾å¤§å’Œç©ºé—´æ”¾å¤§ä¸Šçš„ä¸è¶³ï¼ŒLSM-treeèƒ½å¤Ÿé€šè¿‡åˆå¹¶éšæœºå†™å‡å°‘å†™æ”¾å¤§ï¼Œä»¥åŠé€šè¿‡é«˜æ•ˆçš„å‹ç¼©å‡å°‘ç©ºé—´æ”¾å¤§ï¼ˆå¯¹æ¯ä¸€å±‚å¯ä»¥é€‰ç”¨ä¸åŒçš„å‹ç¼©ç®—æ³•ï¼‰ã€‚å¦‚ä¸‹è¡¨ï¼Œè¿›è¡Œäº†ç®€å•çš„å¯¹æ¯”ï¼š

|            | InnoDB                               | RocksDB                                  |
| ---------- | ------------------------------------ | ---------------------------------------- |
| ç‚¹æŸ¥       | ä»ä¸Šåˆ°ä¸‹æŒ‰ç…§æŸä¸ªåˆ†æ”¯è¿›è¡Œå®šä½ã€‚       | é€å±‚æŸ¥æ‰¾ï¼Œå¯ä»¥åŸºäºbloom filterè¿›è¡Œè¿‡æ»¤ã€‚ |
| range scan | ç›´æ¥æŒ‰ç…§leafnodeçš„nextæŒ‡é’ˆè¿›è¡Œéå†ã€‚ | éœ€è¦åˆå¹¶ä¸åŒå±‚çš„æ•°æ®ã€‚                   |
| delete     | æ ‡è®°åˆ é™¤                             | æ ‡è®°åˆ é™¤ï¼Œtombstoneï¼›singledeleteä¼˜åŒ–ã€‚  |

ç›®å‰RocksDBæä¾›äº†åŸºæœ¬çš„KVæ“ä½œï¼Œå¯¹åº”çš„Keyä¸­ä¿å­˜äº†æ“ä½œç±»å‹ï¼š

```cpp
// <user key, sequence number, and entry type> tuple.
struct FullKey {
  Slice user_key;
  SequenceNumber sequence;
  EntryType type;
  
  ...
}
// User-oriented representation of internal key types.
enum EntryType {
  kEntryPut,
  kEntryDelete,
  kEntrySingleDelete,
  kEntryMerge,
  kEntryRangeDeletion,
  kEntryValueIndex,
  kEntryMergeIndex,
  kEntryOther,
};
```

æ¯ç§æ“ä½œçš„æ¥å£å¸¦æœ‰ç›¸åº”çš„Optionï¼Œæ¯”å¦‚è¿™äº›åŸºæœ¬æ“ä½œï¼š

```cpp
DB* db;
Options options;
options.create_if_missing = true;
Status s = DB::Open(options, kDBPath, &db);
assert(s.ok());

s = db->Put(WriteOptions(), "key1", "value");
assert(s.ok());
std::string value;
s = db->Get(ReadOptions(), "key1", &value);
assert(s.ok());

// Atomically apply a set of updates
{
  WriteBatch batch;
  batch.Delete("key1");
  batch.Put("key2", value);
  s = db->Write(WriteOptions(), &batch);
}
```

> PinnableSlice:
>
> å°†getçš„è·å–çš„valueï¼Œå°†stringæ¢æˆPinnableSliceï¼›å¦‚æœæ•°æ®å·²ç»åœ¨block cacheä¸­ï¼Œå¯å…å»ä¸€æ¬¡memcpyã€‚

é™¤äº†åŸºæœ¬KVæ“ä½œå¤–ï¼ŒRocksDBæä¾›äº†äº†ä¸€äº›é¢å¤–æ“ä½œï¼Œå…³é”®çš„æœ‰ï¼šMergeå’ŒCompactã€‚

## Merge

> Mergeå¯çœ‹ä½œæ˜¯ä¸€ä¸ªå‡çº§ç‰ˆçš„Putï¼ŒPutç›´æ¥ç»™å‡ºkeyçš„æ–°å€¼ï¼ŒMergeä¼šæ ¹æ®å½“å‰Valå¾—åˆ°æ–°å€¼ã€‚

ä¸ºäº†å‡å°‘read-modify-writeæ—¶çš„é¢å¤–IOä»£ä»·ï¼Œå¼•å…¥äº†Merge Operatorã€‚è¿™æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„å›è°ƒæ“ä½œï¼Œç”¨æˆ·å°†**å¢é‡æ›´æ–°**è¯­ä¹‰æŠ½è±¡åœ¨Mergeæ“ä½œä¸­ï¼›

Mergeæ“ä½œçš„å…·ä½“æ‰§è¡Œæ—¶æœºå¯èƒ½åœ¨Getçš„æ—¶å€™ï¼Œä¹Ÿå¯èƒ½åœ¨Compactæ¸…ç†çš„æ—¶å€™ï¼›è¿™æ—¶Mergeçš„æ“ä½œå¯¹è±¡å¯èƒ½å·²ç»ç´¯ç§¯ä¸å°‘äº†ã€‚è¦è®¡ç®—åˆ°Mergeè®°å½•çš„valï¼Œéœ€è¦å‘å‰è¿½æº¯ï¼Œç›´åˆ°æ‰¾åˆ°è¯¥keyçš„ä¸€ä¸ªPutæˆ–è€…Deleteè®°å½•ï¼›å°†Putçš„valå’Œmergeçš„valè¿›è¡Œåˆå¹¶ï¼Œæœ€åå¾—åˆ°æ­£ç¡®çš„å€¼ï¼›ï¼ˆè¿™å«FullMergeï¼‰

ä½†æœ‰å¯èƒ½mergeçš„é“¾å¾ˆé•¿ï¼Œè¿™ä¸ªæ“ä½œå°±å¾ˆè€—æ—¶ï¼›ä¸ºé¿å…è¿™ä¸ªé—®é¢˜ï¼Œç”¨æˆ·çš„ä½¿ç”¨åœºæ™¯ä¸­ï¼Œå¦‚æœMergeè¯­ä¹‰èƒ½å¤Ÿçº§è”ï¼ˆå³ï¼ŒMergeçš„è¾“å‡ºå¯ä»¥ä½œä¸ºå¦ä¸€ä¸ªMergeçš„è¾“å…¥ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥å®šä¹‰`PartialMerge`æ¥å£ï¼Œè¿™æ ·å¯ä»¥æå‰å¯¹å¤šä¸ªMergeæ“ä½œè¿›è¡Œéƒ¨åˆ†åˆå¹¶æˆä¸€ä¸ªmergeï¼›å‡å°‘äº†æœ€å`FullMerge`æ—¶çš„mergeé‡ã€‚å°†IOä»£ä»·è¿›è¡Œå‡æ‘Šï¼Œè¿™æ ·å¾—åˆ°ä¸€ä¸ªçº¿æ€§æ‰©å±•çš„æ€§èƒ½æ›²çº¿ã€‚

> `PartialMerge`
>
> it should be known that PartialMerge() is an optional function, used to combine two merge operations (operands) into a single operand. For example, combining OP(k-1) with OPk to produce some OP', which is also a merge-operation type. 

ç”¨æˆ·ä¸€èˆ¬ç»§æ‰¿å­ç±»`AssociativeMergeOperatorå®ç°è‡ªå·±çš„é€»è¾‘ï¼Œ`AssociativeMergeOperator`å°†`FullMerge`å’Œ`PartialMere`åˆå¹¶ä¸ºä¸€ä¸ªMergeï¼Œæ¯”å¦‚ä¸‹è¿™äº›Operatoréƒ½æœ‰å¢é‡æ›´æ–°çš„ç‰¹ç‚¹ã€‚

```cpp
storage/rocksdb/terarkdb/utilities/merge_operators/bytesxor.h <<GLOBAL>>
             class BytesXOROperator : public AssociativeMergeOperator {
storage/rocksdb/terarkdb/utilities/merge_operators/string_append/stringappend.h <<GLOBAL>>
             class StringAppendOperator : public AssociativeMergeOperator {
storage/rocksdb/terarkdb/utilities/merge_operators/uint64add.cc <<GLOBAL>>
             class UInt64AddOperator : public AssociativeMergeOperator {
```

## Compact

Compactæ˜¯lsm-treeçš„ä¸€ä¸ªå…³é”®æ“ä½œï¼Œä¹‹å‰è¯´è¿‡äº†ã€‚rocksdbé»˜è®¤çš„ç­–ç•¥æ˜¯Leveled Compactionï¼Œç”¨åœ¨sst file compactä¸­ï¼›ä½†æ˜¯ä¸åŒå±‚è§¦å‘æ¡ä»¶ä¸åŒï¼š

+ level0ï¼šå”¯ä¸€ä¸€å±‚å…è®¸sstfileçš„keyrangeæœ‰overlapï¼ŒåŸºäºè¯¥å±‚æ–‡ä»¶ä¸ªæ•°level0_file_num_compaction_triggerã€‚
+ å…¶ä»–ï¼šTotal file size for other

> Universal compaction(sized-tiered)å¯è®¤ä¸ºç”¨åœ¨flush memtableä¸­ï¼›å¤šä¸ªoverlapçš„memtableåˆå¹¶ä¸ºä¸€ä¸ªssttableã€‚ï¼Ÿ

å…¶å®æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç”±äºL0çš„keyæ˜¯é‡å çš„ï¼Œé‚£ä¹ˆL0åˆ°L1çš„Compactä¸èƒ½å¹¶å‘è¿›è¡Œï¼›è¿™é‡Œé€šè¿‡sub-compactionè¿›è¡Œä¼˜åŒ–ï¼Œå³ï¼Œå…ˆæ”¶é›†æ–‡ä»¶ä¿¡æ¯ï¼Œå°†å•ä¸ªæ–‡ä»¶æŒ‰offsetè¿›è¡Œåˆ†å‰²ï¼Œæœ€åæ¯ä¸ªrangeäº¤ç”±ä¸€ä¸ªsubCompactè¿›è¡Œå¤„ç†ã€‚

> è§`ShouldFormSubcompactions`å†³å®šæ˜¯å¦å°†å½“å‰çš„compactåˆ’åˆ†æˆ Sub-Compactionã€‚

rocksdbç›¸æ¯”Btreeç±»å‹ï¼Œæ­£å¼å› ä¸ºä¸éœ€è¦in-place-updateæ‰èƒ½æœ‰è¾ƒå¥½çš„å†™å…¥é€Ÿåº¦ï¼›ä½†æ˜¯ä¹Ÿæ­£æ˜¯å› ä¸ºä¸in-place-updateï¼Œå°±å­˜åœ¨ç©ºé—´è†¨èƒ€çš„é—®é¢˜ï¼›å°±éœ€è¦è¿›è¡Œç©ºé—´æ”¶ç¼©ï¼›ç±»ä¼¼äºVacuumï¼ŒCompactionä¸»è¦ä½œç”¨ä¹Ÿæ˜¯å›æ”¶æ—§ç‰ˆæœ¬å¹¶æ¸…ç†å·²åˆ é™¤çš„æ•°æ®ï¼›æ³¨æ„ï¼Œç”±äºMerge è®°å½•çš„å­˜åœ¨ï¼Œä¼šå½±å“åŸæ¥[Compactå¯¹æ—§æ•°æ®çš„å›æ”¶](https://github.com/facebook/rocksdb/wiki/Merge-Operator-Implementation#compaction)ã€‚å…³äºCompactæ›´è¯¦ç»†çš„é€»è¾‘ï¼Œå†³å®šç­‰åé¢ä¸“é—¨æ•´ç†ä¸€ç¯‡ã€‚

åœ¨rocksdbçš„Compactä¸­ï¼Œå€¼å¾—ä¸€æçš„æ˜¯â€”â€”åœ¨è¿‡æ»¤æ•°æ®çš„æ—¶å€™ï¼Œå¯ä»¥å®šä¹‰Compaction filterï¼ŒæŒ‰ç…§ç”¨æˆ·å®šä¹‰çš„é€»è¾‘ï¼Œè¿›è¡Œæ•°æ®æ•´ç†ï¼Œæ¯”å¦‚åˆ é™¤è¿‡æœŸï¼ˆè¿‡æœŸæ—¶é—´è‡ªå®šä¹‰ï¼‰æ•°æ®ï¼Œè½¬æ¢æ•°æ®å†…å®¹ç­‰ç­‰ï¼›Compact filteråªå¯¹æ™®é€švalueç±»å‹ï¼ˆæœªæ ‡è®°ä¸Šdelete markï¼‰è°ƒç”¨ï¼Œå¯¹äºmergeç±»å‹ï¼Œä¼šåœ¨æ‰§è¡Œmerge operatorå‰è°ƒç”¨Compaction filterã€‚

> flushå¯çœ‹ä½œæ˜¯ä¸€ç§ç‰¹æ®Šçš„Compactï¼Œä½†flushä¸ä¼šè°ƒç”¨Compaction filterã€‚
>
> Before release 6.0, if there is a snapshot taken later than the key/value pair, RocksDB always try to prevent the key/value pair from being filtered by compaction filter so that users can preserve the same view from a snapshot, unless the compaction filter returns `IgnoreSnapshots() = true`. However, this feature is deleted since 6.0, after realized that the feature has a bug which can't be easily fixed. Since release 6.0, with compaction filter enabled, RocksDB always invoke filtering for any key, even if it knows it will make a snapshot not repeatable.
>

Compactfilterçš„å®ç°ä¸»è¦æœ‰ä¸‰ä¸ªæ¥å£ï¼š

+ Filter

+ FilterMergeOperand

+ FilterV2ï¼šè¿”å›Decisionå¯¹è±¡ï¼Œå…è®¸æ›´æ”¹valueï¼Œå‰ä¸¤è€…åªæ˜¯è¿”å›æ˜¯å¦è¿‡æ»¤çš„boolï¼›

  ```cpp
    enum class Decision {
      kKeep,
      kRemove,
      kChangeValue,
      kRemoveAndSkipUntil,
    };
  ```

## Q&A

çœ‹ä»£ç æ—¶çš„ä¸€äº›å°é—®é¢˜çš„è‡ªé—®è‡ªç­”ğŸ˜‚ï¼š

1. WALæŒ‰ç†è¯´æ˜¯é¡ºåºå†™çš„ï¼Œæ¯æ¬¡åªéœ€è¦åˆ·æœ€åä¸€ä¸ªlogå°±è¡Œäº†ï¼Œä¸ºå•¥è¦foreachå‘¢ï¼Ÿ

![image-20200428141052855](/image/rocksdb/logs.png)

# MyRocks 

MyRocksæœ€åˆæ˜¯ç”±FBå¼€å‘çš„ï¼Œç›®å‰å­˜åœ¨ä¸‰ä¸ªä¸»è¦åˆ†æ”¯ï¼šMariaDBã€Perconaã€FBï¼Œç•¥æœ‰ä¸åŒï¼Œä½†å¤§è‡´ç›¸ä¼¼ã€‚è¿™é‡Œä»¥Perconaç‰ˆæœ¬è¿›è¡Œä»‹ç»ï¼Œç›®å‰æœ€æ–°çš„MyRocks8+å¯¹åº”çš„RocksDB6+ï¼›

MyRocksçš„ä¸»è¦featureæ˜¯ï¼šå†™ä¼˜åŒ–ã€é«˜å‹ç¼©çš„äº‹åŠ¡å‹å­˜å‚¨å¼•æ“ï¼ˆç±»ä¼¼äºPgSQLçš„éš”ç¦»çº§åˆ«ï¼šRead Committed, Repeatable Readï¼‰ã€‚

> ç›¸æ¯”äºMySQLï¼ˆInnoDBï¼‰ï¼ŒMyRocksçš„å±€é™ï¼šhttps://www.percona.com/doc/percona-server/LATEST/myrocks/limitations.html
>

ä¸€ä¸ªRockDBçš„æ•°æ®åº“åªèƒ½åŒæ—¶è¢«ä¸€ä¸ªè¿›ç¨‹æ‰“å¼€ï¼Œè¿™æ˜¯RocksDBé¿å…ä¹±ç”¨çš„ç­–ç•¥ï¼Œè€Œåœ¨ä¸€ä¸ªMyRocksè¿›ç¨‹å†…ï¼Œä¸åŒçº¿ç¨‹å¯ä»¥å¹¶å‘è®¿é—®ã€‚MyRocksçš„ä¸€äºŒçº§ç´¢å¼•æ˜¯æŒ‰ç…§KVçš„æ–¹å¼å­˜å‚¨åœ¨RocksDBä¸­ï¼Œå…¶ä¸­ç´¢å¼•çš„KVå†…å®¹å¦‚ä¸‹è¡¨ï¼š

|                 | Key                                                          | Value                        | Metadata           |
| --------------- | ------------------------------------------------------------ | ---------------------------- | ------------------ |
| Primary Index   | Internal Index IDï¼ˆ4bytesï¼‰+ primary key columns             | remaining columns + checksum | Sequence ID + flag |
| Secondary Index | Internal Index IDï¼ˆ4bytesï¼‰+ secondary key columns + primary key (å»é‡) | checksumï¼ˆoptionalï¼‰         | Sequence ID + flag |

+ è¿™é‡Œchecksumæ˜¯ä¸€ä¸ªå¯é€‰çš„é€‰é¡¹ï¼Œé€šè¿‡å‚æ•°æ‰“å¼€ï¼š

  ```sql
  set GLOBAL rocksdb_store_row_debug_checksums = 1; 
  set GLOBAL rocksdb_verify_row_debug_checksums = 1;
  ```

+ Internal Index IDæ˜¯å†…éƒ¨é€’å¢çš„ç´¢å¼•å·ï¼Œç»´æŠ¤åœ¨ç³»ç»Ÿè¡¨`ROCKSDB_GLOBAL_INFO`ä¸­ï¼›å› ä¸ºä½¿ç”¨äº†**Prefix Key Encoding**ï¼ŒInternal Index IDä¸ä¼šå­˜åœ¨ç©ºé—´ä»£ä»·ã€‚å¦å¤–ï¼ŒMetadataéƒ¨åˆ†å¯ä»¥é€šè¿‡**Zero-Filling metadata**æŠ€æœ¯è¿›è¡Œå‹ç¼©ã€‚

  > **Prefix Key Encoding**
  >
  > RocksDBä¸­ï¼Œé€šè¿‡å¤šåˆ—ç´¢å¼•æ”¯æŒcovering secondary indexï¼Œåœ¨ç´¢å¼•ä¸­å°†å‰ç¼€è¿›è¡Œä¿®æ•´ï¼Œè¾¾åˆ°å‹ç¼©ç©ºé—´çš„ç›®çš„ã€‚
  >
  > **Zero-Filling metadata**
  >
  > åœ¨InnoDBçš„recordä¸Šï¼Œæœ‰äº‹åŠ¡IDï¼ˆ6 bytesï¼‰å’Œå›æ»šæ®µæŒ‡é’ˆï¼ˆ7 bytesï¼‰ï¼Œä½†æ˜¯ä¸å¯å‹ç¼©ï¼›RocksDBä¸­æ¯ä¸ªKVä¸Šæœ‰ä¸€ä¸ªsequence idï¼ˆ7 bytesï¼‰å’Œæ“ä½œç¬¦æ ‡è¯†ï¼ˆ1 bytesï¼‰ï¼Œæ˜¯å¯ä»¥å‹ç¼©çš„ï¼Œå¹¶ä¸”å¦‚æœsequence idåœ¨MVCCä¸­ç”¨ä¸åˆ°ï¼Œé‚£ä¹ˆå¯ä»¥ç½®é›¶ã€‚

å’ŒInnoDBçš„Primary Indexç›¸åŒï¼ŒRocksDBçš„Primary IndexåŒæ ·æ˜¯èšé›†ç´¢å¼•ï¼›å› æ­¤ï¼ŒåŸºäºä¸»é”®çš„æŸ¥è¯¢å¯ä»¥ä¸€æ­¥åˆ°ä½ï¼ˆä¾‹å¦‚ï¼Œwhere a=1ç›¸å…³è®°å½•éƒ½åœ¨ä¸€èµ·ï¼Œç›´æ¥å®šä½ï¼‰ï¼›åŸºäºäºŒçº§ç´¢å¼•çš„æŸ¥è¯¢ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡Covering Indexé¿å…å¯¹ä¸»é”®çš„äºŒæ¬¡æŸ¥è¯¢ã€‚åŒæ ·åœ°ï¼Œå¯¹äºæ²¡æœ‰ä¸»é”®çš„è¡¨ï¼ŒRocksDBä¼šåˆ›å»ºä¸€ä¸ªéšè—ä¸»é”®ï¼Œç§°ä¹‹ä¸ºHidden Primary Keyï¼ˆæ³¨æ„ï¼ŒRocksDBä¸­çš„éšå¼ä¸»é”®å¯¹SQLå±‚æ˜¯é€æ˜çš„ï¼Œå› æ­¤ä¸ä¼šè®°å½•åœ¨binlogä¸­ï¼Œå¯¹æé«˜å¤åˆ¶é€Ÿåº¦æ²¡æœ‰å¸®åŠ©ï¼‰ï¼›

å¦å¤–ï¼Œå¦‚æœMyRocksçš„è¡¨å¼€å¯äº†TTLç‰¹æ€§ï¼Œå¹¶ä¸”æ²¡æœ‰æ˜¾å¼æŒ‡å®šTTLåˆ—ï¼Œé‚£ä¹ˆåœ¨ç´¢å¼•è®°å½•ä¸­ä¼šæœ‰éšå¼çš„TTLåˆ—çš„ä¿¡æ¯ï¼›åœ¨PrimaryKeyä¸­ï¼Œä½äºvalueçš„å‰8ä¸ªbyteã€‚

```cpp
// bit flags which denote myrocks specific fields stored in the record
  // currently only used for TTL.
  enum INDEX_FLAG {
    TTL_FLAG = 1 << 0,

    // MAX_FLAG marks where the actual record starts
    // This flag always needs to be set to the last index flag enum.
    MAX_FLAG = TTL_FLAG << 1,
  };
```

æœ€åï¼Œåœ¨åˆ›å»ºè¡¨å’Œç´¢å¼•æ—¶ï¼Œå¯åœ¨INDEX COMMENTä¸­æŒ‡å®šCFï¼ŒCFä¸indexæ˜¯1ï¼šNçš„å…³ç³»ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šCFï¼Œå°†æ”¾åœ¨default-CFä¸­ï¼ˆæ³¨æ„ï¼Œä¸è¦åˆ›å»ºå¤ªå¤šçš„CFï¼Œ20ä¸ªè¶³ä»¥ï¼‰ï¼Œå¯ä»¥åˆ†åˆ«é…ç½®æ¯ä¸ªCFçš„å±æ€§ï¼Œåœ¨ç³»ç»Ÿè¡¨information_schema.ROCKSDB_CF_OPTIONSä¸­æŸ¥çœ‹ã€‚RocksDBæœ‰ä¸ªå¼Šç«¯ï¼šå‰å‘æ‰«æå¿«ï¼ŒORDER BY DESCæ…¢ï¼ˆåŸå› ï¼Ÿï¼‰ï¼Œè¿™é‡Œå¯ä»¥åœ¨CFä¸ŠåŠ **rev:**æ ‡è®°ï¼Œæ˜¯è¡¨ç¤ºåˆ›å»ºä¸€ä¸ªReversed Column Familyï¼Œç”¨äºä¼˜åŒ–æ­¤ç±»æŸ¥è¯¢ã€‚

```sql
CREATE TABLE `linktable` (
`id1` bigint unsigned,
`id1_type` int unsigned,
`id2` bigint unsigned,
`id2_type` int unsigned,
`link_type` bigint unsigned,
`visibility` tinyint NOT NULL,
`data` varchar NOT NULL,
`time` bigint unsigned NOT NULL,
`version` int unsigned NOT NULL,
PRIMARY KEY (link_type, `id1`,`id2`) COMMENT 'cf_link_pk',
KEY `id1_type` (`id1`,`link_type`,`visibility`,`time`,`version`,`data`) COMMENT 'rev:cf_link_id1_type'
) ENGINE=RocksDB DEFAULT COLLATE=latin1_bin;
```

ä»¥ä¸Šï¼Œå¯¹MyRocksæ•´ä½“ä¸Šè¿›è¡Œäº†ç®€å•ä»‹ç»ï¼Œä¸‹é¢ç€é‡å¯¹å‡ ä¸ªè¾ƒé‡è¦çš„ç‚¹è¿›è¡Œä»‹ç»ï¼š

## IO

IOä¸å¾—ä¸æçš„å°±æ˜¯compactï¼Œåœ¨MyRocksä¸­åå°ä¼šå‘¨æœŸæ€§çš„è§¦å‘compactï¼Œä¹Ÿå¯æ‰‹åŠ¨çš„compactï¼š

```sql
mysql> set session rocksdb_manual_compaction_threads=16;
Query OK, 0 rows affected (0.00 sec)

mysql> set global rocksdb_compact_cf='default';
Query OK, 0 rows affected (25 min 13.80 sec)

MySQL [(none)]> show status like "rocksdb_manual_compaction%";
+--------------------------------------+-------+
| Variable_name                        | Value |
+--------------------------------------+-------+
| rocksdb_manual_compactions_processed | 0     |
| rocksdb_manual_compactions_running   | 1     |
+--------------------------------------+-------+
2 rows in set (0.00 sec)
```

è¯»å–çš„æ—¶å€™ï¼Œä»æŒ‰ç…§å±‚çº§ä»ä¸Šåˆ°ä¸‹å®šä½keyï¼Œè¿™å°±æ„å‘³å¾ˆå¤§çš„è¯»æ”¾å¤§ï¼Œå¯ä»¥é€šè¿‡cacheã€filterç­‰æŠ€æœ¯è¿›è¡Œä¼˜åŒ–ï¼›`GetApproximateSizes`å¾—åˆ°æŸåŒºé—´çš„å¤§æ¦‚å…ƒç»„æ•°ï¼Œåœ¨MySQL optimizerä¸­ç”¨æ¥æ‰¾æœ€ä½³æŸ¥è¯¢è®¡åˆ’ã€‚

InnoDBåœ¨æ•°æ®å˜æ›´æ—¶ï¼Œå¦‚æœpageä¸åœ¨bufferpoolä¸­ï¼Œä¼šå‘ç”Ÿ reads on index writesã€‚RocksDBç›´æ¥putåˆ°Active MemTableä¸­å³å¯ã€‚Deleteä¼šåœ¨æ•°æ®ä¸Šæ¶ä¸€ä¸ªtombstoneï¼Œåç»­çš„è¯»å–ä¼šå¿½ç•¥è¯¥keyæ‰€æœ‰putè¯­å¥ï¼›å¦‚æœæŸä¸ªkeyçš„putæ“ä½œåªå‡ºç°äº†ä¸€æ¬¡ï¼Œé‚£ä¹ˆæ‰§è¡Œdeleteæ—¶ï¼Œåšsingledeleteï¼›å³çœŸæ­£çš„åˆ é™¤æ•°æ®ã€‚

åœ¨MyRocksä¸­ï¼Œä¼šé€šè¿‡å‚æ•°ä¸»åŠ¨æ§åˆ¶å†™å…¥çš„é€Ÿç‡ï¼Œæ¯”å¦‚ä¸‹é¢è¿™äº›ï¼š

| rocksdb_rate_limiter_bytes_per_sec    | æ§åˆ¶memtable flushå’Œcompactçš„å†™ç›˜é€Ÿåº¦        | 0    |
| ------------------------------------- | -------------------------------------------- | ---- |
| rocksdb_delayed_write_rate            | å†™ç›˜é€Ÿåº¦åˆ°è¾¾è¯¥é˜ˆå€¼ï¼ˆè½¯ï¼‰åï¼Œä¸»åŠ¨é™ä½å†™ç›˜é€Ÿåº¦ | 16MB |
| rocksdb_flush_log_at_trx_commit       | ç±»ä¼¼äºinnodb_flush_log_at_trx_commit         | 1    |
| rocksdb_cache_index_and_filter_blocks | æ˜¯å¦ç¼“å­˜indexå’Œfilterçš„block                 | on   |
| ...                                   | ...                                          | ...  |

```cpp
enum class WriteStallCondition {
  kNormal,
  kDelayed,
  kStopped,
};
```

compressionå‘ç”Ÿåœ¨flushå’ŒCompactçš„è¿‡ç¨‹ä¸­ã€‚decompressionå‘ç”Ÿåœ¨è¯»å–çš„æ—¶å€™ï¼Œåœ¨å†…å­˜cacheä¸­æ˜¯è§£å‹åçš„blockï¼›decompressionç›¸æ¯”äºcompressionæ›´åŠ é¢‘ç¹ï¼Œè¿™è¦æ±‚decompressionåº”è¯¥æ›´é«˜æ•ˆã€‚

ä¸€èˆ¬**DB:GET**ä¼šä¼ å…¥ä¸€ä¸ªstringç±»å‹çš„æŒ‡æ­£æ¥æ¥å—valueå€¼ï¼Œä¸ºä¼˜åŒ–valueçš„memcpyçš„ä»£ä»·ï¼ŒRocksDBè®¾è®¡äº†`PinnableSlice`ç»“æ„ï¼Œè¿™æ ·å¦‚æœRocksDBä»block cacheä¸­è¿”å›valueï¼Œé‚£ä¹ˆå¯ä»¥å‡å°‘ä¸€æ¬¡å†…å­˜æ‹·è´ï¼Œç›´æ¥ä»block cacheä¸­è¿”å›ã€‚ç›´åˆ°æ”¹PinnableSliceææ„æˆ–Resetæ‰é‡Šæ”¾block cacheå¯¹åº”æ•°æ®çš„å¼•ç”¨ã€‚

```cpp
PinnableSlice pinnable_val;
while (!stopped) { 
   auto s = db->Get(opt, cf, key, &pinnable_val);
   // ... use it
   pinnable_val.Reset(); // then release it immediately
}
```

> Benchmark:https://github.com/facebook/rocksdb/pull/1756#issuecomment-286201693

### Snapshot

å¹¶å‘æ§åˆ¶å®ç°æ–¹å¼ä¸€èˆ¬å°±ä¸¤ä¸ªæ–¹é¢ï¼šLockå’ŒMVCCï¼›MyRocksçš„é”ç²’åº¦æ˜¯row lockï¼ŒåŠ é”çš„å¯¹è±¡æ˜¯ä¸»é”®keyï¼Œ**å¯¹äºæ— ä¸»é”®è¡¨çš„è¡¨è¯´ï¼ŒRocksDBå†…éƒ¨ä¼šæœ‰éšå¼ä¸»é”®ï¼Œæ‰€åŠ é”éƒ½åœ¨éšå¼ä¸»é”®ä¸Š** ã€‚é”åŠ›åº¦å¯æ”¯æŒå…±äº«é”å’Œæ’å®ƒé”ï¼š

```
 /* Type of locking to apply to rows */
 enum { RDB_LOCK_NONE, RDB_LOCK_READ, RDB_LOCK_WRITE } m_lock_rows;
```

å…¶é”ä¿¡æ¯éƒ½åœ¨å†…å­˜ä¸­ï¼Œä¸ºäº†ä¸å ç”¨å¤ªå¤šå†…å­˜ç©ºé—´ï¼Œé€šè¿‡å‚æ•°`rocksdb_max_row_locks`å¯¹æ¯ä¸ªäº‹åŠ¡å¯è·å–çš„é”æ•°é‡è¿›è¡Œæ§åˆ¶ï¼›æ³¨æ„è‡ªåŠ¨æ­»é”æ£€æµ‹é»˜è®¤ä¹Ÿæ˜¯å…³é—­çš„ï¼Œé€šè¿‡å‚æ•°`rocksdb_deadlock_detect`æ‰“å¼€ã€‚

å…³äºGap Lockï¼Œç›¸æ¯”äºInnoDBçš„Gap lockï¼ŒMyRocksçš„GapLockä¸ä¼šé”ä½æ²¡æœ‰æ‰¾åˆ°çš„recordï¼›åªæœ‰Gapçš„èŒƒå›´æ˜¯æ•´ä¸ªPrimary Keyï¼Œæ‰ä¼šä½¿ç”¨å’ŒInnoDBç›¸åŒã€‚è¿™ä¹Ÿè¦æ±‚MyRocksçš„masterè¦åŸºäºRow basedè¿›è¡Œå¤åˆ¶ï¼›å¦‚ä¸‹ä¾‹ï¼Œåœ¨masterä¸Šï¼Œå…ˆæ‰§è¡Œdeleteè¯­å¥ï¼Œç”±äºMyRocksçš„GapLockåªä¼šå°†ID=10çš„recordé”ä½ï¼Œå› æ­¤updateè¯­å¥å¯ä»¥åœ¨deleteä¹‹å‰æäº¤ï¼Œé‚£ä¹ˆåœ¨å®é™…çš„binlogä¸­ï¼Œå¦‚æœé‡‡ç”¨statementçš„æ–¹å¼å¤åˆ¶ï¼Œslaveç«¯å°±å…ˆæ‰§è¡Œupdateådeleteï¼Œè¿™æ ·ä¸»ä»æ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚

![image-20200303114709689](/image/20200227-gaplock.png)

å› æ­¤ï¼Œå¦‚æœå°†InnoDBä¸Šçš„ä¸šåŠ¡è¿ç§»åˆ°MyRocksä¸Šï¼Œèƒ½å¤Ÿå‡å°‘ä¸€äº›é”çš„ç«äº‰ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„GapLockçš„é—®é¢˜ï¼›æœ‰äº›ä¾èµ–gaplockçš„æŸ¥è¯¢ï¼Œåœ¨MyRocksä¸­ä¼šè¿”å›Deadlockçš„é”™è¯¯ï¼Œæœ‰äº›å¹¶ä¸èƒ½æœ‰æ•ˆå®Œæˆã€‚

```
ERROR 1105 (HY000): Using Gap Lock without full unique key in multi-table or multi-statement transactions
```

ä¸ºæ’æŸ¥è¿™ä¸ªé—®é¢˜ï¼ŒFacebookçš„MyRocksæä¾›äº†ä¸¤ä¸ªå‚æ•°ï¼š`gap_lock_raise_error`å’Œ`gap_lock_write_log`ï¼›è€ŒPerconaæ˜¯æ‰“å¼€çš„ï¼Œå¹¶ä¸”æ²¡æœ‰å‚æ•°æ§åˆ¶ã€‚

> éœ€è¦gaplockçš„æŸ¥è¯¢ï¼Œä¸»è¦æ˜¯ä¸€äº›æŸ¥è¯¢è¯­ä¹‰ä¸Šéœ€è¦å°†è¡¨ä¸­ä¸å­˜åœ¨çš„keyä¹Ÿé”ä¸Šï¼Œæ¯”å¦‚:
>
> 1. empty check
> 2. prefix uniqueness
> 3. blocking queue
> 4. pt-table-checksum

ç»¼ä¸Šï¼Œåœ¨MyRocksä¸­ï¼Œåªæœ‰åœ¨updateå’Œdeleteæ—¶æ‰ä¼šé’ˆå¯¹ä¸»é”®ç´¢å¼•ä¸Šçš„ä¸»é”®ï¼ˆæ— è®ºå­˜åœ¨ä¸å¦ï¼‰è¿›è¡ŒåŠ é”ï¼Œä¸”åŠ çš„æ˜¯æ’å®ƒé”ï¼›selectæ“ä½œä¸€èˆ¬é€šè¿‡Snapshotè¯»å–æ•°æ®ï¼Œåªæœ‰åœ¨`selectÂ ...Â inÂ shareÂ mode`æ—¶ï¼Œæ‰ä¼šä½¿ç”¨å…±äº«é”ã€‚MyRockså’ŒPostgreSQLç±»ä¼¼ï¼Œåˆ†åˆ«åœ¨è¯­å¥çº§åˆ«å’Œäº‹åŠ¡çº§åˆ«å–å¿«ç…§ï¼Œè·å¾—RCå’ŒRRçš„éš”ç¦»çº§åˆ«ï¼Œä½†æ˜¯ä¸æ”¯æŒRUå’ŒSerializableçš„éš”ç¦»çº§åˆ«ï¼Œæœ‰ä¸€ç‚¹åŒºåˆ«æ˜¯ï¼ŒRRçº§åˆ«ä¸‹PostgreSQLæ˜¯åœ¨äº‹åŠ¡å¼€å§‹æ—¶è·å–çš„å¿«ç…§ï¼ŒMyRocksæ˜¯åœ¨ç¬¬ä¸€æ¡è¯­å¥è·å–å¿«ç…§ã€‚

åœ¨InnoDBä¸­ï¼Œåé¢çš„äº‹åŠ¡æ›´æ–°äº†å‰é¢äº‹åŠ¡çš„æ•°æ®ï¼Œåœ¨RCã€RRçº§åˆ«ä¸‹éƒ½å¯ä»¥overwriteï¼›è€Œåœ¨MyRocksä¸­ï¼Œåªæœ‰åœ¨RCçº§åˆ«ä¸Šæ‰å¯ä»¥ï¼Œè¿™å’ŒPostgreSQLç›¸åŒï¼Œåœ¨RRä¸­æŒ‰ç…§first-commit-winçš„æ–¹å¼è¿›è¡Œrollbackï¼›

RocksDBä¸­æ¯æ¡æ•°æ®æœ‰ä¸€ä¸ªsequence numberï¼Œsequence numberä¸€ä¸ªä½œç”¨æ˜¯ç”¨åœ¨Snapshotä¸­ï¼Œé€šè¿‡`GetSnapshot`è·å¾—ä¸€ä¸ªæ•°æ®å¿«ç…§ã€‚å¦‚ä¸‹å®šä¹‰ï¼š

```cpp
// æ‰€æœ‰å¿«ç…§ç»´æŠ¤åœ¨DBå…¨å±€çš„ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œæ¯ä¸ªå¿«ç…§åˆ›å»ºæ—¶æ ¹æ®å½“å‰çš„sequence number ç”Ÿæˆä¸€ä¸ªå¿«ç…§çš„sequence numberã€‚
class SnapshotImpl : public Snapshot {
 public:
  SequenceNumber number_;  // const after creation
  // è§ä¸‹èŠ‚çš„WritePrepared
  SequenceNumber min_uncommitted_ = kMinUnCommittedSeq;

  virtual SequenceNumber GetSequenceNumber() const override { return number_; }

 private:
  friend class SnapshotList;

  SnapshotImpl* prev_;
  SnapshotImpl* next_;

  SnapshotList* list_;                 // just for sanity checks

  int64_t unix_time_;

  // Will this snapshot be used by a Transaction to do write-conflict checking?
  bool is_write_conflict_boundary_;
};
```

æŸå¿«ç…§åªèƒ½çœ‹åˆ°å°äºç­‰äº`number_`çš„æ•°æ®ã€‚å¦‚å›¾ï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦SeqID=5çš„å¿«ç…§ï¼Œåœ¨è¯»å–å¿«ç…§æ•°æ®è¿‡ç¨‹ä¸­ï¼Œåœ¨5åˆ°å½“å‰æ–°çš„2000ä¹‹é—´çš„SeqIDï¼Œå¯èƒ½åœ¨FLushå’ŒCompactionè¿‡ç¨‹ä¸­è¢«åˆå¹¶äº†ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦éå†è¿‡å¤šçš„ç‰ˆæœ¬ã€‚

![image-20200303154316446](/image/20200227-snapshot.png)

åœ¨RocksDBåšcompactä¼šæ¸…ç†è¿‡æœŸçš„æ•°æ®ï¼Œè¿™æ—¶éœ€è¦ä¸å…¨å±€å¿«ç…§æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œå³ï¼Œå¦‚æœå·²åˆ é™¤æ•°æ®çš„sequence number <= åŒå‘é“¾è¡¨ä¸­snapshotçš„æœ€å°sequence numberï¼Œé‚£ä¹ˆå¯ä»¥æ¸…ç†ã€‚

### writebatch

RocksDBäº‹åŠ¡æäº¤æ—¶ä¿è¯æ•°æ®çš„åŸå­å†™çš„ç»“æ„ï¼Œå°†äº‹åŠ¡æ•°æ®æ•´ä½“åŸå­å†™å…¥åˆ°MEMTableï¼ŒWriteBatchä¸­çš„æ•°æ®ç”±`rep_`ç»“æ„ä¿å­˜ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```cpp
// WriteBatch::rep_ :=
//    sequence: fixed64
//    count: fixed32
//    data: record[count]
// record :=
//    kTypeValue varstring varstring
//    kTypeDeletion varstring
//    kTypeSingleDeletion varstring
//    kTypeRangeDeletion varstring varstring
//    kTypeMerge varstring varstring
//    kTypeColumnFamilyValue varint32 varstring varstring
//    kTypeColumnFamilyDeletion varint32 varstring
//    kTypeColumnFamilySingleDeletion varint32 varstring
//    kTypeColumnFamilyRangeDeletion varint32 varstring varstring
//    kTypeColumnFamilyMerge varint32 varstring varstring
//    kTypeBeginPrepareXID varstring
//    kTypeEndPrepareXID
//    kTypeCommitXID varstring
//    kTypeRollbackXID varstring
//    kTypeBeginPersistedPrepareXID varstring
//    kTypeBeginUnprepareXID varstring
//    kTypeNoop
// varstring :=
//    len: varint32
//    data: uint8[len]
```

å…·ä½“çš„Memtableå†™å…¥å‘ç”Ÿåœ¨ä»€ä¹ˆæ—¶å€™å–å†³äºå‚æ•°`rocksdb_write_policy`ã€‚

+ write_commitedï¼šåœ¨äº‹åŠ¡æäº¤æ—¶å†™å…¥ï¼Œè¿™æ ·åˆ¤æ–­æ•°æ®å¯è§æ€§çš„é€»è¾‘ç®€å•ï¼Œå¹¶ä¸”å›æ»šæ–¹ä¾¿ï¼Œåªéœ€è¦å°†writebatché‡Šæ”¾å³å¯ï¼Œä½†æ˜¯commitæ“ä½œæ¯”è¾ƒé‡ã€‚
+ write_preparedï¼šæå‰åˆ°2pcçš„preparedé˜¶æ®µè¿›è¡Œå†™å…¥ï¼Œä½†æ˜¯åˆ¤æ–­äº‹åŠ¡å¯è§æ€§çš„é€»è¾‘æ›´åŠ å¤æ‚ï¼Œå¹¶ä¸”å›æ»šé€»è¾‘å¤æ‚ï¼Œä½†æ˜¯å‡è½»äº†commitçš„è´Ÿæ‹…ã€‚

> å…³äºwrite_preparedçš„äº‹åŠ¡å¯è§æ€§åˆ¤æ–­ï¼Œå‚è€ƒhttp://mysql.taobao.org/monthly/2018/08/02/

## 2PC

```
    // currently only optimistic transactions use callbacks
    // and optimistic transaction do not support 2pc
```

> PreparedHeap prepared_txns_;
>
> The TransactionDB also keeps track of a min heap of all log numbers containing a prepared section. When a transaction is 'prepared' its WriteBatch is written to a log, this log number is then stored in the transaction object and subsequently the min heap. When a transaction is committed its log number is deleted from the min heap, but it is not forgotten! It is now the duty of each memtable to keep track of the oldest log it needs to keep around until his is successfully flushed to L0.

## Replication

ä¸Šé¢å°†GapLockæåˆ°äº†ï¼ŒMyRocksçš„ä¸»ä»å¤åˆ¶è¦æ±‚ä½¿ç”¨Rowæ¨¡å¼ã€‚slaveé€šè¿‡é…ç½®`relay_log_recovery`å®ç°â€œCrash Safe Slaveâ€ï¼›

master failoverç›¸å¯¹å¤æ‚ç‚¹ï¼Œå¯èƒ½å¦‚æœåŸmasterçš„gtidå¤§äºæ–°masterçš„gtidï¼Œéœ€è¦trim binlogï¼›æ•´ä½“é€»è¾‘å’ŒåŸºäºBinLogçš„MySQLå¤åˆ¶ç›¸åŒï¼Œå¯ä»¥åˆ©ç”¨Group Commitçš„Logical CLockå®ç°MTSï¼Œåªæ˜¯éœ€è¦æ³¨æ„MyRocksä¸­å¯ä»¥é€šè¿‡é…ç½®å‚æ•°[rocksdb_rpl_skip_tx_api](https://www.percona.com/doc/percona-server/LATEST/myrocks/variables.html#rocksdb_rpl_skip_tx_api)ï¼Œè·³è¿‡ä»åº“çš„äº‹åŠ¡å†²çªæ£€æŸ¥ï¼Œæé«˜æ€§èƒ½ï¼ˆä½†è¦æ±‚ä»åº“æ˜¯readonlyçš„ï¼‰ã€‚ï¼ˆä¸è¿‡ï¼Œä¼¼ä¹å—é™äºBinlogçš„å¤åˆ¶æ¶æ„è®¾è®¡ï¼Œä»åº“çš„å¤åˆ¶é€Ÿç‡å­˜åœ¨ä¸€ä¸ªç“¶é¢ˆï¼‰ã€‚

### Read Free Replication

ä¹‹å‰ä»ç«¯è¿›è¡Œæ›´æ–°åˆ é™¤çš„æ—¶å€™ï¼Œéœ€è¦ä»ç£ç›˜è¯»å–æ—§æ•°æ®ï¼Œç”±äºMyRocksé‡‡ç”¨çš„æ˜¯LSM-treeçš„ç»“æ„ï¼Œä»TokuDBè·å¾—çš„å¯å‘ï¼Œå°†åˆ©ç”¨Binlogçš„ä¿¡æ¯ï¼Œä»è€Œ**é¿å…ä»ç£ç›˜è¿›è¡Œéšæœºè¯»å–**ï¼Œå¦‚ä¸‹å›¾å¯¹æ¯”ï¼›è¿™è¦æ±‚ä¸»ç«¯çš„å‚æ•°`binlog_row_image=FULL`å¹¶ä¸”ä»ç«¯ä¸å…è®¸å˜æ›´ã€‚

![image-20200303142957787](/image/20200227-readfreerepl.png)

> å¦å¤–è¿˜æœ‰ä¸€ä¸ªSkip Unique Checksç‰¹æ€§ï¼Œä¹Ÿæ˜¯ç±»ä¼¼çš„é“ç†ã€‚ç”±å‚æ•°`unique_checks`æ§åˆ¶ï¼ŒåŒæ ·è¦æ±‚ä»åº“æ²¡æœ‰å…¶ä»–å˜æ›´è¯·æ±‚ã€‚
>
> slave_exec_modeï¼šå½“ä»åº“å›æ”¾æ—¶å‡ºç°å†²çªçš„å¤„ç†æ–¹å¼ï¼›

ä»¥ä¸Šï¼Œæ­¤æ–‡æŒç»­æ•´ç†æœ¬äººåœ¨æŠ˜è…¾MyRocksè¿‡ç¨‹ä¸­ï¼Œå¯¹MyRocksçš„ä¸€äº›è®¤è¯†å’Œç†è§£ï¼Œä»‹äºç†è§£çš„æ·±åº¦æ˜¯ç”±æµ…å…¥æ·±çš„ï¼Œå¯èƒ½ç›®å‰çš„ç‰ˆæœ¬è®¤è¯†æµ…è–„ï¼Œç”šè‡³æœ‰é”™è¯¯ï¼Œæ¬¢è¿æŒ‡æ­£å­¦ä¹ ã€‚