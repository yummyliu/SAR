---
layout: post
title: äº‹åŠ¡å‹å­˜å‚¨å¼•æ“InnoDBæ¦‚è¿°
date: 2019-07-09 17:06
header-img: "img/head.jpg"
categories: jekyll update
tags:
  - InnoDB
typora-root-url: ../../yummyliu.github.io
---

* TOC
{:toc}
# InnoDBç®€è¿°

![adb](/image/arch-db.png)

åœ¨ä¸€ä¸ªæ•°æ®åº“ç³»ç»Ÿä¸­ï¼Œåˆ†ä¸ºä»¥ä¸Šå‡ ä¸ªéƒ¨åˆ†ï¼›å› ä¸ºMySQLæ˜¯ä¸€ä¸ªå­˜å‚¨å¼•æ“å¯æ‹”æ’çš„ç³»ç»Ÿï¼›InnoDBæ˜¯å…¶é»˜è®¤çš„äº‹åŠ¡æ€§å­˜å‚¨ï¼Œå³ä¸Šå›¾çš„Transaction Storage Manageréƒ¨åˆ†ã€‚æœ¬æ–‡å…ˆç®€å•ä»‹ç»ä¸€ä¸‹MySQLï¼Œç„¶åä»å››ä¸ªæ–¹é¢é˜è¿°InnoDBï¼Œå¸Œæœ›å¸Œæœ›äº†è§£InnoDBçš„äººèƒ½æœ‰æ‰€æ”¶è·ï¼š

![image-20190717105416865](/image/InnoDBæ¦‚è¿°.png)

â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

ç±»ä¼¼PgSQLçš„å¤šè¿›ç¨‹ç»“æ„ï¼ŒMySQLæ˜¯å¤šçº¿ç¨‹ç»“æ„ï¼Œå…¶ä¸­æœ‰å¦‚ä¸‹çš„çº¿ç¨‹è§’è‰²

- User threadï¼šæ¯ä¸ªé“¾æ¥ä¸€ä¸ªçº¿ç¨‹ï¼›
- Master threadï¼šæ•´ä½“æ´»åŠ¨çš„è°ƒåº¦ï¼›æ¯”å¦‚flushï¼Œpurgeï¼Œcheckpointï¼Œinsert buffer mergeç­‰ã€‚
- IO threads
  - read threadsï¼šå¤šçº¿ç¨‹çš„é¢„è¯»
  - write threadsï¼šå¤šçº¿ç¨‹çš„åå°å†™
  - Insert Buffer threadï¼šInsert Bufferåˆå¹¶
  - log threadï¼šåˆ·æ–°log
- Purge threadsï¼šå‘¨æœŸæ€§æ‰§è¡Œçš„åƒåœ¾å›æ”¶
  - æ¸…ç†indexä¸­çš„åºŸå¼ƒå€¼
  - æ¸…ç†è¡¨ä¸­è¢«æ ‡è®°ä¸º`deleted`çš„è®°å½•ã€‚
  - æ¸…ç†undoæ—¥å¿—ä¸­çš„å†å²è®°å½•ï¼ˆrollback segmentï¼‰ã€‚
  
- æ­»é”æ£€æµ‹/Page cleaner (flush)/FTS, Statistics, Monitor, Drop table, Dump

  buffer poolç­‰ä»»åŠ¡çº¿ç¨‹

InnoDBæ‰¿æ‹…äº†MySQLä½œä¸ºä¸€ä¸ªRDBMSçš„äº‹åŠ¡å‹å­˜å‚¨éƒ¨åˆ†çš„å·¥ä½œï¼Œæ¯”å¦‚Lockç®¡ç†ï¼Œè®¿é—®æ–¹æ³•ï¼Œæ—¥å¿—ç®¡ç†ä»¥åŠç¼“å†²åŒºç®¡ç†ã€‚ä¸‹é¢ä»è¿™4ä¸ªæ–¹é¢è¿›è¡Œä»‹ç»ã€‚

# InnoDBçš„è®¿é—®æ–¹æ³•

ç›®å‰æœ‰ä¸‰ç§Btreeï¼ŒRtreeï¼ˆspatial indexï¼‰,å€’æ’ç´¢å¼•ï¼ˆFull-Text Search Indexï¼‰ã€‚è¿™é‡Œä»¥æœ€å¸¸ç”¨çš„Btreeä¸ºä¾‹è¿›è¡Œä»‹ç»ã€‚

## æ–‡ä»¶ç»„ç»‡æ–¹å¼

åœ¨InnoDBä¸­ï¼Œframeä»£è¡¨å†…å­˜çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€ä¸ª16kå•å…ƒï¼Œä¸»è¦ç”¨åœ¨ç¼“å†²åŒºç®¡ç†ä¸­ï¼›pageä»£è¡¨ç‰©ç†å†…å­˜çš„ä¸€ä¸ª16kå•å…ƒï¼Œå…¶ä¸­æ˜¯éœ€è¦å†™å›åˆ°ç£ç›˜çš„æ•°æ®ï¼›è€ŒBlockä»£è¡¨ä¸€ä¸ªControl Blockï¼ˆ`buf_block_t`ï¼‰ï¼Œå¯¹äºæ¯ä¸ªframeå¯¹åº”ä¸€ä¸ªControlBlockç»“æ„è¿›è¡Œæ§åˆ¶ä¿¡æ¯ç®¡ç†ï¼Œä½†è¿™äº›ä¿¡æ¯ä¸å†™å›å†…å­˜ã€‚

åœ¨å¤–å­˜ä¸­ï¼ŒæŒ‰ç…§è¡¨ç©ºé—´ï¼ˆspaceï¼‰è¿›è¡Œç»„ç»‡ï¼›å½“å¯åŠ¨äº†`innodb_file_per_table`å‚æ•°åï¼Œæ¯ä¸ªæ•°æ®è¡¨å¯¹åº”ä¸€ä¸ªæ–‡ä»¶ï¼ˆå‚çœ‹ç³»ç»Ÿè¡¨ï¼š`INFORMATION_SCHEMA.INNODB_SYS_DATAFILES`ï¼‰ã€‚ä½†æ˜¯å…¨å±€å…±äº«çš„å¯¹è±¡ï¼Œéœ€è¦æ”¾åœ¨å…±äº«çš„è¡¨ç©ºé—´space0ï¼ˆå…¨å±€å˜é‡`ï¼šinnodb_data_file_pathï¼Œé»˜è®¤ä¸ºibdata1ï¼‰ä¸­ï¼Œå…¶ä¸­æœ‰å¦‚ä¸‹å¯¹è±¡ï¼š

![image-20190718085149937](/image/ibdata1-overview.png)

> é™¤äº†space0æ˜¯å…±äº«çš„ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡create tablespaceåˆ›å»º[General Tablespace](https://dev.mysql.com/doc/refman/5.7/en/general-tablespaces.html)ï¼ŒåŒæ ·æ˜¯å…¨å±€å…±äº«çš„ã€‚

æ¯ä¸ªspaceæœ‰è‹¥å¹²ä¸ªæ–‡ä»¶æˆ–è€…ç£ç›˜åˆ†åŒºï¼›æ¯ä¸ªfileåˆ†ä¸ºè‹¥å¹²ä¸ªsegmentï¼›å…¶ä¸­æœ‰LeafNodeSegmentã€NonLeafNodeSegmentã€rollbacksegmentä¸‰ç§ç±»å‹ã€‚

æ¯ä¸ªsegmentæ˜¯æŒ‰ç…§extentä¸ºå•ä½è¿›è¡Œä¼¸ç¼©ï¼Œæ¯ä¸ªextentä¸­æœ‰è‹¥å¹²ä¸ªå›ºå®šå¤§å°çš„pageï¼Œå¦‚ä¸‹ å›¾ï¼š

- å¯¹äºuncompressedçš„è¡¨ç©ºé—´ï¼Œpageæ˜¯16Kbï¼›
- å¯¹äºcompressedçš„è¡¨ç©ºé—´ï¼Œpageæ˜¯1~16Kbã€‚

![innodb files](/image/innodb-tablespace.png)

â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

> ä¸¤ä¸ªæ–‡ä»¶ï¼š
>
> **ib_buffer_pool**ï¼š`SET GLOBAL innodb_buffer_pool_dump_at_shutdown=ON;`ï¼ŒMySQLé€€å‡ºçš„æ—¶å€™å°†bufferä¸­çš„spaceid+pageidç¼“å­˜ä¸‹æ¥ï¼š
>
> ```c
> # cat ib_buffer_pool | head -n 3
> 17,2
> 17,1
> 17,3
> ```
>
> **ibtmp1**: ç”±å‚æ•°innodb_temp_data_file_pathæ§åˆ¶ã€‚ä¸´æ—¶è¡¨çš„ç‹¬ç«‹è¡¨ç©ºé—´ã€‚

### Rowformat

é»˜è®¤çš„rowformatç”±å‚æ•°**`innodb_default_row_format`**æ§åˆ¶ï¼Œé»˜è®¤å€¼æ˜¯`DYNAMIC`ã€‚

- `REDUNDANT`ï¼šå¯¹äºVARBINARY,VARCHAR,BLOBå’Œ TEXTç±»å‹ç­‰ç±»å‹ï¼Œå½“é•¿åº¦è¶…è¿‡767byteæ—¶ï¼Œè¶…è¿‡çš„éƒ¨åˆ†ä¼šå­˜å‚¨åœ¨é¢å¤–çš„æº¢å‡ºé¡µä¸­ã€‚
- `COMPACT`ï¼šå’ŒREDUNANTç±»ä¼¼ï¼Œåªæ˜¯æº¢å‡ºä¹Ÿçš„å­˜å‚¨æ›´åŠ ç´§å‡‘ï¼ŒèŠ‚çœ20%çš„ç©ºé—´ã€‚
- `DYNAMIC`ï¼šå’Œä¸Šä¸¤ä¸ªä¸åŒï¼Œå½“åˆ—å€¼è¶…è¿‡40byteæ—¶ï¼Œé‚£ä¹ˆè¡Œä¸­åªå­˜å‚¨ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘é™„åŠ é¡µï¼›ç„¶åæ¯ä¸ªé™„åŠ é¡µå†…è¿˜æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘åç»­æ•°æ®ï¼ŒæŒ‡é’ˆå¤§å°20byteã€‚
- `COMPRESSED`ï¼šå­˜å‚¨æ–¹å¼å’ŒDYNAMICç›¸ä¼¼ï¼Œåªæ˜¯è¯¥æ–¹å¼æ”¯æŒå‹ç¼©è¡¨ã€‚åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ä¸­ä¸å¯ç”¨ï¼Œå› æ­¤è¯¥å‚æ•°ä¸èƒ½è®¾ç½®ä¸ºé»˜è®¤ã€‚

> `REDUNDANT` å’Œ `COMPACT` ç´¢å¼•é”®å€¼æœ€å¤§ä¸º 767 byteï¼Œç„¶è€Œ `DYNAMIC` å’Œ `COMPRESSED` æ”¯æŒæœ€å¤§ä¸º 3072 byteã€‚åœ¨ä¸»ä»å¤åˆ¶ä¸­ï¼Œå¦‚æœ`innodb_default_row_format`åœ¨masterä¸Šè®¾ç½®ä¸º`DYNAMIC` ï¼Œåœ¨slaveä¸Šè®¾ç½®ä¸º `COMPACT` ï¼Œæ‰§è¡Œå¦‚ä¸‹DDLæ“ä½œï¼Œä¸»ä¸ŠæˆåŠŸï¼Œä»ä¼šå¤±è´¥ã€‚
>
> ```
> CREATE TABLE t1 (c1 INT PRIMARY KEY, c2 VARCHAR(5000), KEY i1(c2(3070)));
> ```

**éšè—åˆ—**

+ DB_TRX_IDï¼šåŒºåˆ«äºGTIDæŒ‰ç…§äº‹åŠ¡æäº¤é¡ºåºæ’åˆ—ï¼Œè¿™æ˜¯æŒ‰ç…§äº‹åŠ¡åˆ›å»ºé¡ºåºæ’åˆ—ã€‚éé”å®šè¯»çš„äº‹åŠ¡ä¸ä¼šäº§ç”Ÿã€‚
+ DB_ROLL_PTRï¼šæŒ‡å‘è¯¥è®°å½•çš„å‰ä¸€ä¸ªç‰ˆæœ¬çš„undolog recordã€‚
+ DB_ROW_IDï¼šå¦‚æœæ²¡æœ‰ä¸»é”®ï¼Œä¼šåˆ›å»ºä¸€ä¸ªã€‚

## Btreeçš„åˆ›å»º

ç‰ˆæœ¬<5.5ï¼Œåˆ›å»ºä¸€ä¸ªç´¢å¼•ç›¸å½“äºé‡å»ºä¸€ä¸ªè¡¨ï¼ˆ**CopyTable**ï¼‰ã€‚

ç‰ˆæœ¬>=5.5ï¼ŒåŠ å…¥äº†FastIndexCreateç‰¹æ€§ï¼Œä½†åªå¯¹äºŒçº§ç´¢å¼•æœ‰æ•ˆï¼ˆ**Inplace**ï¼‰ï¼›ç´¢å¼•ä¸­åªæœ‰å‘èµ·createindexæ—¶åˆ»çš„æ•°æ®ï¼Œcreate indexæ—¶åªèƒ½è¯»ä¸èƒ½å†™ã€‚è¿‡ç¨‹æœ‰ä¸»è¦æœ‰å¦‚ä¸‹ä¸‰æ­¥ï¼š

1. æ‰«æè¡¨ï¼Œå»ºç«‹å†…å­˜bufferå’Œä¸´æ—¶æ–‡ä»¶
2. è¿›è¡Œåˆå¹¶æ’åº
3. å°†è¡Œæ’å…¥åˆ°ç´¢å¼•ä¸­

ç‰ˆæœ¬>=5.6.7ï¼ŒåŠ å…¥äº†Online Create Indexçš„ç‰¹æ€§ï¼Œåˆ›å»ºäºŒçº§ç´¢å¼•çš„æ—¶å€™å¯è¯»å¯å†™ï¼ˆè¿˜æ˜¯ä¼šçŸ­æš‚blockä¸€ä¸‹ï¼Œä½†æ˜¯å·²ç»å½±å“å¾ˆå°äº†ï¼‰ï¼›å¯¹äºåˆ›å»ºç´¢å¼•è¿‡ç¨‹ä¸­å¯¹è¡¨è¿›è¡Œçš„ä¿®æ”¹ï¼Œæ”¾åœ¨RowLogï¼ˆä¸æ˜¯redologï¼‰ä¸­ï¼›

Online Create Indexåªæ˜¯é’ˆå¯¹äºŒçº§ç´¢å¼•ï¼Œæ‰§è¡Œè¿‡ç¨‹æœ‰å¦‚ä¸‹å‡ æ­¥ï¼š

1. æ·»åŠ ç³»ç»Ÿå…ƒä¿¡æ¯
2. åˆå§‹åŒ–BTreeæ ¹èŠ‚ç‚¹
3. åŠ è½½ç´¢å¼•æ•°æ®
   1. åˆ›å»ºåˆ†åŒºæœ‰åºçš„mergefile
   2. å¤–éƒ¨å½’å¹¶æ’åº
   3. å¡«å……æ–°ç´¢å¼•
   4. åº”ç”¨Rowlog

å¦‚æœåˆ›å»ºè¿‡ç¨‹ä¸­ï¼ŒMySQLæ•…éšœäº†ï¼›æ•…éšœæ¢å¤æ—¶ï¼Œä¼šä¸¢å¼ƒæœªå®Œæˆçš„Indexã€‚

rowlogæ˜¯ç´¢å¼•åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œå¯¹ç´¢å¼•è¿›è¡Œçš„å¢é‡ä¿®æ”¹çš„ç¼“å­˜ï¼›æŒ‰ç…§å—çš„æ–¹å¼ç»„ç»‡èµ·æ¥ï¼Œä¸€å—å—çš„åº”ç”¨ã€‚

## Btreeçš„æ’å…¥

åœ¨æ’å…¥çš„æ—¶å€™ï¼ŒæŒ‰ç…§å¦‚ä¸‹æƒ…å†µï¼Œå½“å‰pageæ”¾ä¸ä¸‹äº†ã€‚

![Page Merging and Page Splitting](/image/Locality_7.png)

![Page Merging and Page Splitting](/image/Locality_9.png)

é‚£ä¹ˆï¼ŒæŒ‰ç…§nextæŒ‡é’ˆæ‰¾åˆ°ä¸‹ä¸€ä¸ªpageï¼Œå¦‚æœä¸‹ä¸€ä¸ªpageå·²ç»æ»¡äº†ï¼›è¿™æ—¶å°±éœ€è¦è¿›è¡ŒèŠ‚ç‚¹åˆ†è£‚ï¼Œå¤§æ¦‚æœ‰4æ­¥:

1. åˆ›å»ºä¸€ä¸ªæ–°çš„page
2. ç¡®å®šè¦åˆ†è£‚çš„pageä»¥åŠè¦åˆ†è£‚çš„ä½ç½®ã€‚
3. ç§»åŠ¨è®°å½•
4. ä¿®æ”¹nextå’ŒprevæŒ‡é’ˆç­‰èŠ‚ç‚¹ä¿¡æ¯ã€‚

é€šè¿‡å¦‚ä¸‹ç›‘æ§ä¿¡æ¯ï¼Œå¯ä»¥ç»Ÿè®¡InnoDBä¸­èŠ‚ç‚¹åˆ†è£‚çš„æ¬¡æ•°ã€‚

```sql
SET GLOBAL innodb_monitor_enable = index_page_splits;
SET GLOBAL innodb_monitor_enable = index_page_reorg_attempts;
select * from INFORMATION_SCHEMA.INNODB_METRICS where name = 'index_page_reorg_attempts'\G
select * from INFORMATION_SCHEMA.INNODB_METRICS where name = 'index_page_splits'\G
```

å½“èŠ‚ç‚¹åˆ†è£‚åï¼Œåœ¨çˆ¶èŠ‚ç‚¹ä¸­æ’å…¥ä¸€ä¸ªnode_ptrï¼Œçˆ¶èŠ‚ç‚¹ä¹Ÿéœ€è¦åˆ†è£‚æ˜¯ï¼›è¿˜æ˜¯é€’å½’çš„è°ƒç”¨èŠ‚ç‚¹åˆ†è£‚å‡½æ•°ï¼Œç›´åˆ°ä¸äº§ç”Ÿåˆ†è£‚ä¸ºæ­¢ï¼›å¦‚æœåˆ†è£‚åˆ°æ ¹èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ ¹èŠ‚ç‚¹äº§ç”Ÿä¸€ä¸ªæ–°çš„æ ¹èŠ‚ç‚¹ï¼Œè€æ ¹èŠ‚ç‚¹å› ä¸ºæ»¡äº†ï¼Œè¿˜æ˜¯ä¼šä¸€åˆ†ä¸ºäºŒï¼›æœ€ç»ˆæå‡æ ‘é«˜ã€‚

## Btreeçš„åˆ é™¤

é¦–å…ˆBtreeçš„åˆ é™¤ä¸ç­‰äºSQLçš„deleteï¼ŒSQLçš„deleteåªæ˜¯æ ‡è®°åˆ é™¤ï¼Œæ‰§è¡Œçš„æ˜¯delete_markæ“ä½œï¼›å…·ä½“çš„Btreeçš„åˆ é™¤ï¼Œç”±purgeçº¿ç¨‹è°ƒåº¦æ‰§è¡Œ(æˆ–è€…æ˜¯rollback)ã€‚

åœ¨BtreePageä¸­æœ‰ä¸€ä¸ªMERGE_THRESHOLDï¼Œé»˜è®¤æ˜¯0.5ï¼›å½“BtreePageç”±äºdeleteæˆ–è€…updateï¼ˆæ–°è®°å½•çš„å¤§å°æ¯”å†å²è®°å½•å°ï¼‰ä½¿å¾—å®¹é‡å°äº0.5ï¼›é‚£ä¹ˆå°±ä¼šé€šè¿‡å‰å‘å’Œåå‘æŒ‡é’ˆæŸ¥çœ‹ç›¸é‚»èŠ‚ç‚¹æ˜¯å¦ä¹Ÿå¯ä»¥mergeã€‚

å¦‚ä¸‹ï¼Œå½“åˆ é™¤äº†è®°å½•ï¼Œpageä¸­çš„è®°å½•å¤§å°å°äºé˜ˆå€¼æ—¶ã€‚

![img](/image/Locality_3.png)

![img](/image/Locality_4.png)

é‚£ä¹ˆå°±ä¼šå’Œç›¸é‚»èŠ‚ç‚¹è¿›è¡Œåˆå¹¶ï¼›å°†åç»­èŠ‚ç‚¹çš„æ•°æ®å¤åˆ¶åˆ°å‰é¢çš„èŠ‚ç‚¹ä¸­ï¼Œé‚£ä¹ˆå¦ä¸€ä¸ªèŠ‚ç‚¹å°±æˆç©ºèŠ‚ç‚¹äº†ï¼Œå¯ä»¥ç”¨æ¥æ”¾æ–°çš„æ•°æ®ã€‚

![img](/image/Locality_5.png)

![Page Merging and Page Splitting](/image/Locality_6.png)

é€šè¿‡å¦‚ä¸‹ç›‘æ§ï¼ŒæŸ¥çœ‹btreeçš„mergeæ“ä½œç»Ÿè®¡ã€‚

```sql
SET GLOBAL innodb_monitor_enable = index_page_merge_successful;
select * from INFORMATION_SCHEMA.INNODB_METRICS where name = 'index_page_merge_successful'\G
```

å½“mergeåˆ°æœ€åï¼Œå‘ç°è‡ªå·±æ²¡æœ‰å·¦å³é‚»å±…èŠ‚ç‚¹æ—¶ï¼Œé‚£ä¹ˆå°†å­èŠ‚ç‚¹çš„å†…å®¹ï¼Œå¤åˆ¶åˆ°çˆ¶èŠ‚ç‚¹ä¸Šï¼›å‡å°‘æ ‘é«˜ã€‚æ³¨æ„åˆ é™¤çš„æ—¶å€™éœ€è¦å°†Btreeè¿›è¡Œrebalanceã€‚

# InnoDBç¼“å†²åŒºç®¡ç†

![image-20190718110436034](/image/InnoDB-caching.png)

åœ¨InnoDBä¸­ï¼Œæœ‰å¦‚ä¸‹ä¸€äº›ç¼“å†²åŒºï¼›å¤§ç±»ä¸Šå’ŒPgSQLç›¸ä¼¼éƒ½æœ‰ä¸€ä¸ªæ”¾æ•°æ®é¡µçš„BufferPoolï¼Œå’Œä¸€ä¸ªæ”¾æ—¥å¿—è®°å½•çš„LogBufferã€‚åœ¨CHECKPOINTçš„è°ƒåº¦ä¸‹ï¼Œè¿›è¡ŒBufferPoolåˆ·ç›˜ï¼›æ¯æ¬¡äº‹åŠ¡commitè¿›è¡ŒLogBufferåˆ·ç›˜ã€‚

é™¤äº†è¿™ä¸¤ä¸ªä¹‹å¤–ï¼Œè¿˜æœ‰ä¸ºäº†å‡å°äºŒçº§ç´¢å¼•çš„å†™æ”¾å¤§ï¼Œå¼•å…¥çš„Change Bufferæœºåˆ¶ï¼›ä¸ºäº†é¿å…æ•°æ®éƒ¨åˆ†å†™ï¼Œå¼•å…¥çš„DoubleWrite Bufferã€‚

> å¦å¤–ï¼Œè¿˜æœ‰å­˜å‚¨å…ƒæ•°æ®ç›®å½•ä¸å…¶ä»–å†…éƒ¨ç»“æœçš„Memory Poolï¼Œç”±å‚æ•°`innodb_additional_mem_pool_size`æ§åˆ¶ï¼Œé»˜è®¤8MBï¼›è¿™ä¸ªå¦‚æœä¸å¤Ÿå°±ä¼šåŠ¨æ€ç”³è¯·ï¼Œç„¶åå†æ—¥å¿—ä¸­å†™warningè®°å½•ã€‚

## Change Buffer

Insert Bufferæ˜¯äºŒçº§ç´¢å¼•å˜æ›´çš„ç¼“å­˜ï¼›ä¹‹å‰åªæœ‰insertæ“ä½œï¼Œåæ¥ä¹Ÿæ”¯æŒäº†delete/update/purgeæ“ä½œï¼Œæˆä¸ºChangeBufferï¼›ä½†æ˜¯å‘½åä¸Šæ²¡æœ‰æ”¹å˜ï¼Œåœ¨å†…å­˜ä¸­è¿˜æ˜¯å«InsertBufferï¼›æ³¨æ„åªæ˜¯å½“éå”¯ä¸€çš„äºŒçº§ç´¢å¼•çš„å—ä¸åœ¨ç¼“å­˜ä¸­æ—¶ï¼Œæ‰ä¼šç¼“å­˜ç›¸å…³æ“ä½œã€‚

> ç´¢å¼•å…·æœ‰å”¯ä¸€çº¦æŸæ—¶ï¼Œä¿®æ”¹ç´¢å¼•éœ€è¦è¯»å–æ•°æ®ç¡®è®¤æ˜¯å¦å­˜å‚¨é‡å¤å€¼ã€‚

å½“ChangeBufferæ»¡äº†æˆ–è€…ä¹‹å‰ç¼ºå¤±çš„äºŒçº§ç´¢å¼•é¡µè¢«è¯»å–åˆ°å†…å­˜ä¸­æ—¶ï¼Œä¼šæŒ‰ç…§changeBufferä¸­ç¼“å­˜çš„æ“ä½œï¼Œmergeè¯¥é¡µçš„ä¿®æ”¹ã€‚

1. éšæœºé€‰æ‹©changeBufferä¸­ä¸€ä¸ªéšæœºé¡µã€‚
2. éšæœºæ‰“å¼€è¯¥é¡µä¸­çš„ä¸€ä¸ªcursorã€‚
3. æŒ‰ç…§è¯¥cursorï¼Œè¯»å–ä¹‹åçš„è‡³å¤š8ä¸ªé¡µã€‚
4. å¼‚æ­¥å‘èµ·IOè¯·æ±‚ï¼›å½“è¯»å–å®Œæˆåï¼Œè°ƒç”¨å›è°ƒå‡½æ•°ï¼Œæ‰§è¡Œç›¸åº”çš„changeã€‚

## Buffer Pool

å­˜æ”¾è¡¨å’Œç´¢å¼•çš„æ•°æ®ï¼Œç”±`innodb_buffer_pool_size`è®¾ç½®ï¼Œé»˜è®¤æ˜¯128MBï¼›æ¨èé…ç½®ä¸ºç³»ç»Ÿç‰©ç†å†…å­˜çš„80%ã€‚

### CHECKPOINT

CHECKPOINTåœ¨DBMSéƒ½æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼Œå…¶ä¸ºredoæ—¥å¿—ä¸­çš„ä¸€æ¡è®°å½•ï¼Œå…¶è¡¨ç¤ºåœ¨è¯¥è®°å½•ä¹‹å‰çš„æ•°æ®é¡µçš„æ›´æ”¹å·²ç»ä»ç¼“å†²åŒºå†™å…¥ç£ç›˜äº†ã€‚

> æœ‰ä¸¤ç§ç±»å‹çš„CHECKPOINTï¼š
>
> **sharp checkpoint**:
>
> åªå°†commitedçš„äº‹åŠ¡ä¿®æ”¹çš„é¡µè¿›è¡Œåˆ·ç›˜ï¼Œå¹¶ä¸”è®°ä¸‹æœ€æ–°Commitedçš„äº‹åŠ¡çš„LSNã€‚è¿™æ ·æ¢å¤çš„æ—¶å€™ï¼Œredoæ—¥å¿—ä»CHECKPOINTå‘ç”Ÿçš„LSNå¼€å§‹æ¢å¤å³å¯ã€‚ç”±äºæ‰€æœ‰åˆ·ç›˜çš„æ•°æ®éƒ½æ˜¯åœ¨åŒä¸€ä¸ªç‚¹(CHECKPOINT LSN)ä¹‹åï¼Œæ‰€ä»¥ç§°ä¹‹ä¸ºsharpã€‚
>
> **fuzzy checkpoint:**
>
> å¦‚æœè„é¡µæ»ç•™åˆ°ä¸€å®šæ—¶é—´ï¼Œå°±å¯èƒ½ä¼šåˆ·ç›˜ã€‚è¿™ç§æ–¹å¼åœ¨æ—¥å¿—ä¸­å†™ä¸‹ä¸¤ä¸ªLSNï¼šCHECKPOINT startå’ŒCHECKPOINT endã€‚å½“æ¢å¤çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä»CHECKPOINT startå¼€å§‹æ¢å¤ã€‚
>
> â€”â€”[Gray and Reuterâ€™s classic text on transaction processing](https://www.amazon.com/gp/product/1558601902/?tag=xaprb-20)

åœ¨InnoDBä¸­ï¼Œé™¤äº†shutdownçš„æ—¶å€™ï¼Œæ­£å¸¸æ—¶å€™éƒ½æ˜¯fuzzy CHECKPOINTã€‚åˆ·ç›˜å‰ï¼Œèƒ½å¤Ÿå¤šæ¬¡ä¿®æ”¹ï¼Œè¿™æ ·çœå»äº†å¾ˆå¤šIOã€‚

æ± ä¸­çš„é¡µç”±ä¸‰ä¸ªlistç»´æŠ¤ï¼Œåˆ†åˆ«æ˜¯ï¼š

+ free_listï¼šå¯ç”¨çš„é¡µ
+ LRU_listï¼šæœ€è¿‘ä½¿ç”¨çš„é¡µ
+ flush_listï¼šæŒ‰ç…§LSNçš„é¡ºåºç»„ç»‡çš„è„é¡µï¼ˆå³ï¼Œæœ€è¿‘ä¿®æ”¹çš„é¡µï¼‰ã€‚

ç”±äºbufferæ± æ˜¯æœ‰é™çš„ï¼Œä¸èƒ½åªæ˜¯ç­‰æ»¡äº†æ‰è¿›è¡Œé¡µæ¢å‡ºï¼ˆLRU_listï¼‰ï¼›æ‰€ä»¥ï¼ŒInnoDBä¼šæŒç»­åœ°è¿›è¡ŒCHECKPOINTï¼Œè¿™é‡Œä¸»è¦å’Œflush_listç›¸å…³ã€‚åŸºäºflush_listçš„æ¢å‡ºå°±æ˜¯é€‰æ‹©æœ€æ—©æ›´æ”¹çš„è„é¡µ(LSN)è¿›è¡Œæ¢å‡ºã€‚å› æ­¤ï¼ŒInnoDBä¸­çš„æ¢å‡ºæœ‰ä¸¤ç§æƒ…å†µã€‚

- BufferPoolæ»¡äº†ä¹‹åï¼ŒåŸºäºLRU_listï¼Œè¿›è¡Œé¡µé¢ç½®æ¢ã€‚
- ä¸»åŠ¨è¿›è¡Œåˆ·ç›˜ï¼ŒåŸºäºflush_listï¼Œå…¶ä¸­æŒ‰ç…§ä¿®æ”¹çš„å…ˆåé¡ºåºæ’åˆ—ã€‚

> ä¸ºäº†é¿å…å°†çƒ­æ•°æ®æ¢å‡ºï¼Œæ‰€ä»¥é€‰æ‹©äº†æœ€æ—©æ›´æ”¹çš„è„é¡µã€‚å¦å¤–ï¼Œç”±äºäº‹åŠ¡æ—¥å¿—ï¼ˆå³ï¼Œredo/walæ—¥å¿—ï¼‰æ˜¯å›ºå®šå¤§å°çš„ï¼Œå› æ­¤ï¼Œredoæ—¥å¿—æ˜¯å¾ªç¯ä½¿ç”¨çš„ã€‚å½“æœ€æ—©çš„æ—¥å¿—è®°å½•ç›¸åº”çš„é¡µä¸€ç›´æ²¡æœ‰åˆ·ç›˜ï¼Œå¦‚æœæ­¤æ—¶å‘ç”Ÿäº†æ—¥å¿—é‡ç”¨ï¼Œé‚£ä¹ˆæ›´æ”¹å°±æ²¡æœ‰æŒä¹…åŒ–(è¿åD)ï¼›å› æ­¤ï¼Œå½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼ŒInnoDBéœ€è¦å¤¯ä½ï¼Œè¿›è¡Œåˆ·ç›˜ï¼ˆåŒæ ·è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆé€‰æ‹©æœ€æ—©æ›´æ”¹çš„è„é¡µçš„ä¸€ä¸ªåŸå› ï¼‰ã€‚
>

ç»¼ä¸Šï¼Œå½“InnoDBæ‰§è¡Œfuzzy CHECKPOINTçš„æ—¶å€™ï¼Œå…¶ä¼šæ‰¾åˆ°flush_listä¸­çš„æœ€æ—©æ›´æ”¹çš„è„é¡µçš„LSNï¼Œå°†å…¶ä½œä¸ºCHECKPOINTçš„startï¼Œå†™å…¥äº‹åŠ¡æ—¥å¿—å¤´ä¸­(å‚è§æºç ï¼š`log_checkpoint_margin`å’Œ`log_checkpoint`)ã€‚

è€Œå½“InnoDBåœæœºæ—¶ï¼Œåšæ³•å°±æ˜¯sharp checkpointã€‚é¦–å…ˆï¼Œåœæ­¢æ•°æ®æ›´æ–°ï¼›ç„¶åï¼Œå°†è„é¡µåˆ·ç›˜ï¼›æœ€åï¼Œå°†å½“å‰çš„LSNå†™å…¥äº‹åŠ¡æ—¥å¿—å¤´ä¸­ã€‚

> å¦å¤–ï¼Œåœ¨Perconaç‰ˆæœ¬çš„XtraDBä¸­ï¼Œæä¾›äº†ä¸€ç§åŸºäºä»£ä»·çš„ adaptive CHECKPOINTï¼›ä»¥åŠInnoDBåæ¥ä¹Ÿæœ‰äº†[adaptive flushing](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_adaptive_flushing)ã€‚

## Doublewrite Buffer(disk)

é€šè¿‡[`innodb_doublewrite`](https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_doublewrite)å‚æ•°æ‰“å¼€dwbufferã€‚,é»˜è®¤æ‰“å¼€ã€‚InnoDBçš„é¡µå¤§å°æ˜¯16kï¼Œä½†æ˜¯OSæ¯æ¬¡æ˜¯æŒ‰ç…§4Kå†™å…¥ï¼Œå› æ­¤å¯èƒ½å­˜åœ¨16Kåªå†™äº†ä¸€éƒ¨åˆ†çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿcrashäº†ã€‚ä¸ºäº†é¿å…è¿™ä¸€é—®é¢˜ï¼Œè®¾è®¡äº†doublewrite_bufferã€‚

dwbufferå¯ä»¥çœ‹åšæ˜¯å­˜åœ¨äº**ç³»ç»Ÿè¡¨ç©ºé—´**ä¸­çš„ä¸€ä¸ªçŸ­æœŸçš„æ—¥å¿—æ–‡ä»¶ï¼Œå®ƒåŒ…å«äº†100ä¸ªé¡µã€‚å½“InnoDBåˆ·é¡µæ—¶ï¼Œä¼šå…ˆå°†é¡µ**é¡ºåº**å†™å…¥åˆ°dwbufferä¸­ï¼Œå¹¶å°†dwbufferåˆ·ç›˜ï¼›ç„¶åï¼Œå°†é¡µåˆ·åˆ°çœŸæ­£çš„æ•°æ®æ–‡ä»¶ä¸­ã€‚

å½“recoveryæ—¶ï¼ŒInnoDBæ£€æŸ¥dwbufferä¸­é¡µå’Œå…¶æœ¬æ¥ä½ç½®çš„é¡µçš„å†…å®¹ï¼›å¦‚æœé€šè¿‡æ£€æŸ¥é¡µçš„checksumï¼Œå‘ç°æ•°æ®è¡¨ä¸­çš„é¡µæ˜¯ä¸ä¸€è‡´çš„ï¼Œé‚£ä¹ˆä»dwbufferä¸­æ¢å¤ã€‚

æ€§èƒ½ä¸Šï¼Œå°½ç®¡æ¯æ¬¡å†™é¡µçš„æ—¶å€™éœ€è¦å†™ä¸¤æ¬¡ï¼›ä½†æ˜¯ç”±äºå°†dwbufferçš„å†™æ˜¯é¡ºåºçš„ï¼Œå¹¶ä¸”ä¸ä¼šæ¯ä¸ªpageè°ƒç”¨ä¸€æ¬¡fsyncï¼Œè€Œæ˜¯ä¸€èµ·fsyncï¼›æ•´ä½“æ€§èƒ½æ¯”åŸæ¥æŸå¤±ç»éªŒå€¼æ˜¯5%ã€‚

> å¦‚æœä½ ä¸åœ¨ä¹æ•°æ®ä¸¢å¤±ï¼Œæˆ–è€…OSçº§åˆ«ä¿è¯äº†ä¸ä¼šæœ‰éƒ¨åˆ†å†™ï¼Œé‚£ä¹ˆå¯ä»¥`innodb_doublewrite=0` å…³é—­double writeã€‚

## Log Buffer

InnoDBçš„è¡¨å‘ç”Ÿå˜æ›´çš„æ—¶å€™ï¼Œé¦–å…ˆå°†å˜æ›´å­˜å‚¨åœ¨Log Bufferä¸­ï¼Œç„¶åå†™å…¥åˆ°Redoæ—¥å¿—ä¸­ã€‚å…¶ç”±`innodb_log_buffer_size`è®¾ç½®ï¼Œé»˜è®¤16MBï¼›å½“å¤§äº‹åŠ¡ä¸­çš„insert/update/deleteæ¯”è¾ƒå¤šæ—¶ï¼Œå°†æé«˜è¯¥å‚æ•°å¯ä»¥å‡å°‘ç£ç›˜IOï¼›é€šè¿‡è§‚å¯Ÿç³»ç»Ÿç»Ÿè®¡`innodb_log_waits`ï¼Œå¯ä»¥å¾—çŸ¥æ˜¯å¦éœ€è¦è°ƒå¤§LogBufferã€‚

```sql
SELECT name, subsystem, status FROM INFORMATION_SCHEMA.INNODB_METRICS;
```

å…³äºLogBufferçš„æ›´è¯¦ç»†ä»‹ç»ï¼Œå‚çœ‹ä¸‹èŠ‚InnoDBæ—¥å¿—ç®¡ç†ã€‚

# InnoDBæ—¥å¿—ç®¡ç†

æ•°æ®åº“æ—¥å¿—æ˜¯ä¿è¯äº‹åŠ¡çš„ACIDçš„é‡è¦æœºåˆ¶ï¼ŒæŒ‰ç…§æ•°æ®æ¢å¤çš„ä¸€èˆ¬ç®—æ³•â€”â€”**ARIES**ï¼Œæ•°æ®åº“çš„æ—¥å¿—ä¸€èˆ¬æœ‰ä¸¤ç§ï¼šREDOå’ŒUNDOï¼›å¦å¤–ï¼Œåœ¨MySQLå±‚ï¼Œè¿˜æœ‰ä¸€ä¸ªBinLogï¼Œä½†å…¶ä¸å±äºInnoDBã€‚

> ARIESçš„ä¸‰ä¸ªåŸåˆ™
>
> - æ—¥å¿—å…ˆå†™ï¼šWrite ahead logging
> - é‡åšå†å²ï¼šRpeating history during Redo
> - è®°å½•å˜æ›´ï¼šLogging change during Undo

è€ŒæŒ‰ç…§æ•°æ®åº“æ—¥å¿—å­˜å‚¨å†…å®¹ï¼Œä¸€èˆ¬åˆ†ä¸ºä¸‰ç§æ—¥å¿—ç±»å‹ï¼š

- çº¯ç‰©ç†æ—¥å¿—ï¼šè®°å½•æ•°æ®é¡µçš„ç‰©ç†å­—èŠ‚ä½ç½®å’Œå†…å®¹ã€‚
- çº¯é€»è¾‘æ—¥å¿—ï¼šè®°å½•æ›´æ”¹çš„è¯­å¥ã€‚
- ç‰©ç†çš„é€»è¾‘æ—¥å¿—ï¼ˆPhysiological Logï¼‰ï¼šè®°å½•ç‰©ç†é¡µä¸­æ›´æ”¹çš„é€»è¾‘ï¼Œè¿™é‡Œçš„é€»è¾‘ä¸æ˜¯SQLé€»è¾‘ï¼Œè€Œæ˜¯ç‰©ç†é¡µä¸­çš„å˜æ›´æ“ä½œã€‚

ç°ä»£DBMSä¸­ï¼Œä¸€èˆ¬é‡‡ç”¨çš„æ˜¯Physiologicalæ–¹å¼ã€‚å…¶æ—¥å¿—ä½“ç§¯æ›´å°ï¼Œæ¢å¤æ›´å¿«ï¼Œå¹¶ä¸”è§£å†³äº†é€»è¾‘æ—¥å¿—çš„éå¹‚ç­‰æ€§ã€‚

> **é€»è¾‘æ—¥å¿—çš„éå¹‚ç­‰æ€§**
>
> æ¯”å¦‚ï¼Œé€»è¾‘æ—¥å¿—ä¸­æœ‰ä¸€ä¸ªinsert a in Aï¼Œå…¶éœ€è¦æ›´æ–°æ•°æ®å’Œç´¢å¼•é¡µã€‚ä½†æ˜¯crashçš„æ—¶å€™ï¼Œå¯èƒ½åªæ›´æ–°äº†dataï¼Œæ²¡æœ‰æ›´æ–°indexã€‚é‚£ä¹ˆï¼Œé‡æ–°æ‰§è¡Œinsertè¯­å¥ï¼Œå°±ä¸èƒ½ä¿è¯æ­£ç¡®æ€§ã€‚

## Mini-Transaction(MTR)

MTRæ˜¯ä¿è¯InnoDBå¯¹ä¸€ä¸ªæˆ–å¤šä¸ªpageå˜æ›´çš„åŸå­æ€§çš„æœºåˆ¶ï¼Œä¸€ä¸ªmträ¸­åŒ…å«äº†ä¸¤ç±»ä¿¡æ¯ï¼š

+ å¯¹è‹¥å¹²pageçš„ä¿®æ”¹çš„**logrecord**

+ ç›¸åº”index/tablespace/pageä¸Šçš„**lock**ï¼Œæˆ–è€…**buffer-fixes**ï¼ˆå¯¹bufferpageçš„å¼•ç”¨ï¼‰ï¼Œè§å¦‚ä¸‹æšä¸¾ç±»å‹ã€‚

  ```c
  /** Types for the mlock objects to store in the mtr memo; NOTE that the
  first 3 values must be RW_S_LATCH, RW_X_LATCH, RW_NO_LATCH */
  enum mtr_memo_type_t {
  #ifndef UNIV_INNOCHECKSUM
  	MTR_MEMO_PAGE_S_FIX = RW_S_LATCH,
  
  	MTR_MEMO_PAGE_X_FIX = RW_X_LATCH,
  
  	MTR_MEMO_PAGE_SX_FIX = RW_SX_LATCH,
  
  	MTR_MEMO_BUF_FIX = RW_NO_LATCH,
  #endif /* !UNIV_CHECKSUM */
  
  #ifdef UNIV_DEBUG
  	MTR_MEMO_MODIFY = 32,
  #endif /* UNIV_DEBUG */
  
  	MTR_MEMO_S_LOCK = 64,
  
  	MTR_MEMO_X_LOCK = 128,
  
  	MTR_MEMO_SX_LOCK = 256
  };
  ```

ç”±äºMTRæ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œåªæœ‰åœ¨mtr.commit()æ—¶ï¼Œä¼šå°†ç”¨æˆ·çº¿ç¨‹çš„mtrå¤åˆ¶åˆ°logbufferä¸­ï¼ˆmtr.commit()æ—¶ï¼Œè¿˜ä¼šé‡Šæ”¾æŒæœ‰çš„é”ï¼‰ã€‚å› æ­¤ä¸å­˜åœ¨å®Œæˆä¸€åŠçš„mtrï¼Œä¹Ÿå°±ä¸å­˜åœ¨mtrçš„rollbackã€‚

ä¸ºäº†é¿å…mtrè·å–indexpageçš„é”æ—¶ï¼Œå‘ç”Ÿæ­»é”ï¼›

+ ä¸€ä¸ªmträ¸­ï¼Œåªèƒ½å˜æ›´ä¸€ä¸ªindexï¼›
+ åªèƒ½å‰å‘éå†ï¼šè·å–ä¸‹ä¸€ä¸ªpageçš„é”æ—¶ï¼Œå¿…é¡»é‡Šæ”¾å‰ä¸€ä¸ªpageçš„é”ã€‚

> ğŸ¤” æ­»é”çš„å‘ç”Ÿæ¡ä»¶ï¼Œå¦‚ä½•é¿å…ï¼Ÿ

## Redo LOG

åœ¨InnoDBä¸­ï¼Œå…¶redoæ—¥å¿—å°±æ˜¯ä¸€ç§Physiologicalçš„æ—¥å¿—ã€‚å…¶ä¸­è®°å½•äº†æ•°æ®é¡µä¸Šçš„æ‰€æœ‰å˜æ›´æ“ä½œã€‚æ¯ä¸ªè®°å½•çš„å½¢å¼å¦‚ä¸‹ï¼š

![innodb-redo-rec](/image/innodb-redo-rec.png)

redoæ—¥å¿—æ˜¯æŒ‰ç…§ç£ç›˜æ‰‡åŒºå¤§å°ï¼ˆ**512byte**ï¼‰çš„å—ï¼Œå­˜å‚¨æ—¥å¿—è®°å½•ï¼Œè€Œä¸æ˜¯æ˜¯pageå¤§å°ï¼Œredologä½äº`$innodb_log_group_home_dir/ib_logfile`ä¸­ï¼Œå¯èƒ½æœ‰å¤šä¸ªæ–‡ä»¶ã€‚

```sql
mysql> show global variables like '%innodb_log_file%';
+---------------------------+----------+
| Variable_name             | Value    |
+---------------------------+----------+
| innodb_log_file_size      | 50331648 |
| innodb_log_files_in_group | 2        |
+---------------------------+----------+
2 rows in set (0.01 sec)
```

å’ŒPostgreSQLçš„max_wal_sizeç±»ä¼¼ï¼Œib_logfileçš„å¤§å°æœ‰ä¸Šé™ï¼ˆ`innodb_log_file_size * innodb_log_files_in_group < 512GB`ï¼‰ï¼›å¦‚æœè®¾ç½®çš„è¿‡å°ï¼Œä¸ºäº†ç¡®ä¿é‡ç”¨redoæ—¥å¿—æ—¶ï¼Œè¢«é‡ç”¨çš„redoæ—¥å¿—å¯¹åº”çš„é¡µå·²ç»åˆ·ç›˜ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šé¢‘ç¹çš„åˆ·è„ï¼Œè¿™æ—¶å¯ä»¥è°ƒå¤§redoçš„æ•´ä½“å¤§å°ã€‚

ä¸ºäº†é¿å…checkpointçš„é¢‘ç¹åˆ·è„ï¼Œå°†pagecleanerå’Œç”¨æˆ·çº¿ç¨‹ä¼šæŒ‰ç…§ä¸€äº›é˜ˆå€¼ç‚¹ï¼Œè¿›è¡Œæå‰åˆ·è„ã€‚å› æ­¤ï¼Œä¸šåŠ¡**updateçš„ååé‡**å’Œ**CHECKPOINTå›æ”¶redoæ–‡ä»¶**éƒ½å’Œè¿™ä¸ªç›¸å…³ã€‚

å› ä¸ºï¼Œæˆ‘ä»¬recoveryçš„æ—¶å€™éœ€è¦é‡åšè¿™äº›è®°å½•ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶ä¸çŸ¥é“crashçš„æ—¶å€™ç›¸åº”è®°å½•çš„ä¿®æ”¹æœ‰æ²¡æœ‰è½ç›˜ï¼Œå› æ­¤å¯èƒ½ä¼šå¤šæ¬¡æ‰§è¡Œï¼Œæ‰€ä»¥å…¶ä¸­è®°å½•ä¿è¯å¹‚ç­‰æ€§([idempotent](http://books.google.com/books?id=S_yHERPRZScC&lpg=PA543&ots=JJtxVQOEAi&dq=idempotent gray&pg=PA543#v=onepage&q=idempotent gray&f=false))ã€‚

å…¶å®å½“recoveryçš„æ—¶å€™ï¼Œå’ŒPostgreSQLç±»ä¼¼ä¼šæ¯”è¾ƒæ—¥å¿—çš„lsnä¸é¡µé¢çš„lsnçš„å¤§å°ï¼Œåªä¼šé‡åšlsnå¤§çš„æ—¥å¿—ã€‚

> **åŒä¸€ä¿è¯**
>
> é»˜è®¤å°†`innodb_flush_log_at_trx_commit`è®¾ç½®ä¸º1ï¼Œä¿è¯æ—¥å¿—Write Aheadï¼›é™¤éç³»ç»Ÿå±‚é¢ä¿è¯äº†æ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œå¦‚**battery backed raid card**ã€‚
>
> å¦å¤–è¿˜æœ‰ä¸Šå±‚MySQLçš„`sync_binlog`ï¼›ä¹Ÿéœ€è¦è®¾ç½®ä¸º1ï¼Œä¿è¯binlogè½ç›˜ã€‚

ä¸ºäº†æé«˜æ•´ä½“çš„ååé‡ï¼ŒInnoDBé‡‡ç”¨ç»„æäº¤çš„æ–¹å¼ï¼Œä»è€Œå‡å°‘åˆ·ç›˜çš„æ¬¡æ•°ï¼ˆLogBufferï¼‰ã€‚

> è¿™é‡Œç†è§£å°±æ˜¯æœåŠ¡çš„ååé‡è€Œä¸æ˜¯å“åº”æ—¶é—´ï¼Œå› ä¸ºå¦‚æœç»„æ²¡æœ‰æ»¡ï¼Œå°±ä¸åˆ·ç›˜çš„è¯ï¼Œæ˜¯ä¸æ˜¯å°±å½±å“äº†å‰é¢äº‹åŠ¡çš„å“åº”æ—¶é—´ã€‚åœ¨PostgreSQLä¸­é€šè¿‡`commit_siblings`é…ç½®ä¸€ä¸ªç»„æäº¤å¯ç”¨çš„ä¸‹é™ï¼Œé¿å…ç³»ç»Ÿè´Ÿè½½æ¯”è¾ƒä½çš„æ—¶å€™çš„åˆ·ç›˜ç­‰å¾…ã€‚

### LogBufferçš„å†™å…¥/å†™å‡º

![image-20190619165143347](/image/logbuffer-flush.png)

`log_t*	log_sys`æ˜¯redoæ—¥å¿—ç³»ç»Ÿçš„å…³é”®å…¨å±€å˜é‡ã€‚è¿™é‡ŒåŸºäº5.7ç‰ˆä»£ç ï¼Œé€ä¸€äº†è§£æ¯ä¸ªæˆå‘˜å˜é‡çš„å«ä¹‰ã€‚è¿™é‡Œäº’æ–¥é”çš„ç±»å‹éƒ½æ˜¯ï¼šib_mutex_tï¼›å®é™…ä¸Šæ˜¯åŸºäºFutexæœºåˆ¶å®ç°çš„FutexMutexï¼ˆLinux Fast userspace mutexï¼‰ã€‚

#### mtr_commit

#### trx_commit

##### æ—¥å¿—æœ‰åºå†™å‡º

##### æ•°æ®æœ‰åºå†™å‡º

### MySQL-8.0çš„LogBufferæ— é”ä¼˜åŒ–

#### å†…å­˜æ‹·è´æ— é”ä¼˜åŒ–â€”â€”LinkBuf

#### ä¸“æœ‰çº¿ç¨‹å¼‚æ­¥è½ç›˜

## Undo LOG

ç›¸å¯¹äºPostgreSQLä¸­ï¼Œå°†æ—§ç‰ˆæœ¬çš„æ•°æ®æ”¾åœ¨å½“å‰æ–‡ä»¶ä¸­çš„æ–¹å¼ï¼›InnoDBä¸­å¯ä»¥æœ‰ä¸“é—¨çš„UNDO
 è¡¨ç©ºé—´ï¼ˆ5.6ä¹‹åå¯ä»¥å¯ç”¨ç‹¬ç«‹undoè¡¨ç©ºé—´ï¼Œä¹‹å‰æ˜¯æ”¾åœ¨ç³»ç»Ÿè¡¨ç©ºé—´ibdata0ä¸­ï¼‰ã€‚åœ¨ibdata0ä¸­ï¼Œå­˜å‚¨ä¸€ä¸ªtrx_sysç»“æ„ï¼Œå…¶ä¸­ç»´æŠ¤äº†äº‹åŠ¡ç›¸å…³çš„ä¿¡æ¯ï¼Œå°±åŒ…æ‹¬äº†æ‰€æœ‰çš„128ä¸ªå›æ»šæ®µï¼Œå¦‚ä¸‹å›¾ã€‚

![image-20190718154613462](/image/trx_sys.png)

> æ³¨æ„æ˜¯å›æ»šæ®µï¼Œæ®µå­˜åœ¨äºè¡¨ç©ºé—´ä¸­ï¼›é‚£ä¹ˆæœ‰å¦‚ä¸‹ä½ç½®æ˜ å°„ï¼š
>
> + rollback seg0ä½äºibdata1ä¸­
> + [1,32]ï¼Œæ”¾åœ¨ibtmp1ä¸´æ—¶è¡¨ç©ºé—´ä¸­ã€‚
>
> + [33,+)ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ç‹¬ç«‹è¡¨ç©ºé—´ï¼Œé‚£ä¹ˆç”¨æˆ·å›æ»šæ®µéƒ½åœ¨ibdata1è¿™ä¸ªç³»ç»Ÿè¡¨ç©ºé—´ä¸­ã€‚

![image-20190718161534628](/image/undo-map.png)

å¦‚ä¸Šå›¾ï¼Œä¸€ä¸ªäº‹åŠ¡å¦‚æœåªå¯¹åº”ä¸€ä¸ªUNDOpageï¼ˆå®é™…ä¸Šå¯èƒ½ä¸æ­¢ï¼‰ï¼Œé‚£ä¹ˆæœ€å¤šæ”¯æŒ96*1024ä¸ªäº‹åŠ¡å¹¶å‘ã€‚

> ç”±`innodb_rollback_segments`å®šäº†äº†rollback segmentçš„ä¸ªæ•°([1,128]ï¼‰ï¼Œé»˜è®¤128ä¸ªã€‚æ¯ä¸ªrsegä¸­ï¼Œæœ‰1024ä¸ªslot(ç”¨äº†å­˜æ”¾undo log page)ï¼›
>
> 128ä¸ªrsegåªæœ‰å96ä¸ªæ˜¯ç»™ç”¨æˆ·è¡¨ä½¿ç”¨çš„ï¼Œå¹¶ä¸”æ¯ä¸ªundo logåªèƒ½åŒæ—¶ç»™ä¸€ä¸ªäº‹åŠ¡ä½¿ç”¨ï¼Œå› æ­¤æ•´ä½“çš„äº‹åŠ¡å¹¶å‘ä¸Šé™ä¸º96*1024ã€‚

â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

åœ¨InnoDBä¸­ï¼ŒUndoæ—¥å¿—è®°å½•äº†è¡Œçš„æ—§å€¼ï¼Œå½“éœ€è¦æ‰¾åˆ°æ—§ç‰ˆæœ¬çš„æ•°æ®æ—¶ï¼Œéœ€è¦æŒ‰ç…§undoé“¾è¿›è¡Œå¯»æ‰¾ã€‚æœ‰æ•°æ®å˜æ›´çš„äº‹åŠ¡éƒ½éœ€è¦ä¸€ä¸ªundo recordï¼ŒåŒ…å«ä¸‰é¡¹ä¿¡æ¯ï¼š

- Primary_Key_Valueï¼šåŒ…æ‹¬é¡µå·å’Œç‰©ç†ä½ç½®ã€‚
- Old_trx_idï¼šæ›´æ–°è¯¥è¡Œçš„äº‹åŠ¡å·
- Old_values_on_that_rowï¼šæ›´æ–°å‰çš„æ•°æ®å€¼ã€‚

åœ¨MySQLä¸­ï¼Œäº‹åŠ¡é»˜è®¤æ˜¯åªè¯»äº‹åŠ¡ï¼›å¦‚æœåæœŸå‘ç°æœ‰ä¸´æ—¶è¡¨çš„å†™å…¥ï¼Œå°±åˆ†é…**ä¸´æ—¶è¡¨çš„rseg**ï¼›è‹¥åˆ¤æ–­ä¸ºè¯»å†™äº‹åŠ¡ï¼Œåˆ™å¼€å§‹åˆ†é…äº‹åŠ¡IDå’Œ**æ™®é€šrseg**ã€‚

å¯¹äºInsertæ’å…¥çš„æ–°æ•°æ®ï¼Œæ²¡æœ‰ä»»ä½•è€äº‹åŠ¡å¯èƒ½ä¼šè¯»å–è¯¥æ–°è¡Œï¼Œæ‰€ä»¥ä¸€èˆ¬åœ¨äº‹åŠ¡ç»“æŸåï¼Œå°±å°†undo logåˆ é™¤ï¼Œè¿™éƒ¨åˆ†æ˜¯`insert_undo`ã€‚è€Œå¯¹äºUpdateå’Œdeleteçš„æ—§æ•°æ®ï¼Œéœ€è¦è¿›è¡Œä¿ç•™ï¼Œåœ¨InnoDBä¸­å°†å…¶å½’ä¸ºä¸€ç±»ï¼š`update_undo`ã€‚

å›æ»šæ®µæ˜¯èµ„æºæ˜¯æœ‰é™çš„ï¼Œç³»ç»Ÿæœ‰purgeçº¿ç¨‹å®šæœŸå›æ”¶å›æ»šæ®µï¼›æ¯ä¸ªå›æ»šæ®µä¸Šæœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°(`trx_ref_count`)ï¼Œå¦‚æœè®¡æ•°ä¸º0ï¼Œè¡¨ç¤ºæ²¡æœ‰äº‹åŠ¡åœ¨ä½¿ç”¨ï¼Œé‚£ä¹ˆpurgeçº¿ç¨‹å°±å¯¹å…¶è¿›è¡Œå›æ”¶ï¼›å›æ”¶æ—¶ï¼Œä¼šå°†è¯¥rsegæ ‡è®°ä¸º`skip_allocation`ï¼Œè¡¨ç¤ºè¯¥æ®µæš‚ç¼“åˆ†é…ã€‚

## Crash Recovery

ä¸€èˆ¬æ¢å¤åˆ†ä¸ºä¸‰æ­¥ï¼Œé¦–å…ˆæ‰«ææ•°æ®ï¼›ç„¶ååŸºäºRedoè¿›è¡Œé‡åšï¼›æœ€ååŸºäºUndoè¿›è¡Œå›æ»šã€‚

åœ¨InnoDBä¸­ï¼Œåˆ†ä¸º4æ­¥ï¼š

1. dwbufferï¼šé¦–å…ˆæ¢å¤ Doublewrite Bufferä¸­çš„æ•°æ®

2. Scanï¼šä»ç£ç›˜ä¸­è¯»å–redoæ—¥å¿—è®°å½•ï¼Œæ’å…¥æŒ‰ç…§LSNæ’åºçš„çº¢é»‘æ ‘ä¸­ã€‚

3. Redoï¼š`recv_recovery_from_checkpoint_start`ï¼Œå°†é‡åšredoè®°å½•ï¼Œå¹¶è„é¡µæ’å…¥åˆ°flush_listä¸­ï¼›å¦å¤–ï¼Œundoè®°å½•ä¹Ÿæ˜¯å—redoä¿æŠ¤çš„(ä¸´æ—¶è¡¨é™¤å¤–ä¸´æ—¶è¡¨ä¸è®°redoï¼‰ï¼Œä¹Ÿå¯ä»¥ä»redoä¸­æ¢å¤ã€‚

4. Undoï¼š`dict_boot`åˆå§‹åŒ–æ•°æ®å­—å…¸å­ç³»ç»Ÿï¼›`trx_sys_init_at_db_start`åˆå§‹åŒ–äº‹åŠ¡å­ç³»ç»Ÿï¼Œundoæ®µçš„åˆå§‹åŒ–åœ¨æ­¤å®Œæˆï¼›

   ![image-20190529105306507](/image/init-undo.png)

   å°†Activeçš„äº‹åŠ¡ï¼Œè¿›è¡Œå›æ»šï¼›å¯¹äºPrepareçš„äº‹åŠ¡ï¼Œå¦‚æœå¯¹åº”çš„binlogå·²ç»æäº¤ï¼Œé‚£ä¹ˆæäº¤ï¼Œå¦åˆ™å›æ»šã€‚



# InnoDBçš„é”ç®¡ç†å™¨

## æ˜¾å¼äº‹åŠ¡é”

ä¸€èˆ¬ä»ä¸¤ä¸ªç»´åº¦æè¿°ä¸€ä¸ªé”ï¼šç²’åº¦å’ŒåŠ›åº¦ã€‚åœ¨InnoDBä¸­ï¼Œä»ç²’åº¦ä¸Šåˆ†ä¸ºè¡¨é”å’Œè¡Œé”ï¼›åœ¨ä¸åŒçš„ç²’åº¦ä¸Šï¼Œåˆæ ¹æ®åŠ›åº¦çš„ä¸åŒåˆ†ä¸ºä¸åŒç±»å‹ã€‚ä½†éƒ½æ˜¯åœ¨ä¸€ä¸ªç»“æ„ä¸­è¡¨ç¤º`lock_t`ï¼Œæ ¹æ®`is_record_lock`ï¼ˆæå–type_modeçš„æ ‡è®°ä½ï¼‰æ¥åˆ¤æ–­é”çš„ç²’åº¦ã€‚

```c
	/** Determine if the lock object is a record lock.
	@return true if record lock, false otherwise. */
	bool is_record_lock() const
	{
		return(type() == LOCK_REC);
	}

	ulint type() const {
		return(type_mode & LOCK_TYPE_MASK);
	}
```

type_modeæ˜¯ä¸€ä¸ªæ— ç¬¦å·çš„32ä½æ•´å‹ï¼Œä»ä½ä½æ’åˆ—ï¼Œç¬¬1å­—èŠ‚ä¸ºlock_modeï¼›

```c
/* Basic lock modes */
enum lock_mode {
	LOCK_IS = 0,	/* intention shared */
	LOCK_IX,	/* intention exclusive */
	LOCK_S,		/* shared */
	LOCK_X,		/* exclusive */
	LOCK_AUTO_INC,	/* locks the auto-inc counter of a table in an exclusive mode */
	LOCK_NONE,	/* this is used elsewhere to note consistent read */
	LOCK_NUM = LOCK_NONE, /* number of lock modes */
	LOCK_NONE_UNSET = 255
};
```

ç¬¬2å­—èŠ‚ä¸ºlock_typeï¼›

```c
/** Lock types */
/* @{ */
#define LOCK_TABLE	16	/*!< table lock */
#define	LOCK_REC	32	/*!< record lock */
#define LOCK_TYPE_MASK	0xF0UL
```

å†é«˜çš„å­—èŠ‚ä¸ºè¡Œé”çš„ç±»å‹æ ‡è®°ï¼š

```c
#define LOCK_ORDINARY	0	/*!< this flag denotes an ordinary
				next-key lock in contrast to LOCK_GAP
				or LOCK_REC_NOT_GAP */
#define LOCK_GAP	512	
#define LOCK_REC_NOT_GAP 1024	
#define LOCK_INSERT_INTENTION 2048 
#define LOCK_PREDICATE	8192	/*!< Predicate lock */
#define LOCK_PRDT_PAGE	16384	/*!< Page lock */
```

### è¡¨é”

åœ¨MySQLä¸­ï¼Œè¡¨é”æœ‰æ’ä»–Xå’Œå…±äº«Sä¸¤ç§åŠ›åº¦ã€‚

å½“æˆ‘ä»¬è¦å¯¹æŸä¸ªpageä¸­çš„ä¸€è¡Œè®°å½•è¿›è¡Œé”å®šæ—¶ï¼Œéœ€è¦å¯¹ä¸Šå±‚çš„tableåŠ æ„å‘é”â€”â€”IS/IXï¼Œæ„ä¸ºè¯¥äº‹åŠ¡ä¸­æœ‰æ„å‘å¯¹è¡¨ä¸­çš„æŸäº›è¡ŒåŠ Xã€Sé”ã€‚æ„å‘é”æ˜¯InnoDBå­˜å‚¨å¼•æ“è‡ªå·±ç»´æŠ¤çš„ï¼Œç”¨æˆ·æ— æ³•æ‰‹åŠ¨æ·»åŠ æ„å‘é”ã€‚

é€šè¿‡é˜…è¯»ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºæ‰§è¡Œæ¯æ¬¡æ“ä½œMySQLä¸Šå±‚ç›´æ¥å‘èµ·`MySQL_lock_table->Innodb::external_lock(F_WRLCK/F_RDLCK)`ã€‚ç»“æŸä¹‹åå†`MySQL_unlock_table->Innodb::external_lock(F_UNLCK) `ã€‚å…¶ä¸­æ¨¡å¼åªæœ‰ä¸‰ç§ï¼ˆç›´æ¥ä½¿ç”¨çš„Linuxæ–‡ä»¶æ“ä½œçš„å®å®šä¹‰ï¼‰å¦‚ä¸‹ï¼š

```c
#define F_RDLCK 0
#define F_WRLCK 1
#define F_UNLCK 2
// è¿™æ˜¯linuxå¤´æ–‡ä»¶ä¸­çš„å®šä¹‰ï¼›ä½†æ˜¯åœ¨my_global.hä¸­ï¼Œæ˜¯
#define F_RDLCK 1
#define F_WRLCK 2
#define F_UNLCK 3
// æ³¨æ„åŒºåˆ†
```

æ³¨æ„æ„å‘é”æ˜¯è¡¨çº§åˆ«çš„é”ï¼ˆå…¶å®å°±æ˜¯åœ¨æ•´ä¸ªä¸€çº§ç´¢å¼•ä¸Šçš„index->lockä¸ŠåŠ é”ï¼‰ï¼›å’Œè¡¨é”X/Sæœ‰ç›¸åº”çš„å…¼å®¹æ€§åˆ¤æ–­å¦‚ä¸‹ï¼š

| -    | IS               | IX     | S      | X                |
| ---- | ---------------- | ------ | ------ | ---------------- |
| IS   | å…¼å®¹(compatible) | å…¼å®¹   | å…¼å®¹   | ä¸å…¼å®¹(conflict) |
| IX   | å…¼å®¹             | å…¼å®¹   | ä¸å…¼å®¹ | ä¸å…¼å®¹           |
| S    | å…¼å®¹             | ä¸å…¼å®¹ | å…¼å®¹   | ä¸å…¼å®¹           |
| X    | ä¸å…¼å®¹           | ä¸å…¼å®¹ | ä¸å…¼å®¹ | ä¸å…¼å®¹           |

> InnoDBä¸­ä¸€æ–¹é¢é€šè¿‡é”æ¥è¿›è¡Œå¹¶å‘æ§åˆ¶ï¼ˆ**ä¸€è‡´æ€§é”å®šè¯»**ï¼Œselect for update/select for shared/update where / delete whereï¼‰ï¼›å¦å¤–ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ã€‚äº‹åŠ¡ç¬¬ä¸€æ¬¡è¯»çš„æ—¶å€™ä¼šé€šè¿‡undoç©ºé—´æä¾›çš„å¤šç‰ˆæœ¬ï¼Œæ„å»ºä¸€ä¸ªreadviewï¼Œæä¾›**ä¸€è‡´æ€§éé”å®šè¯»**ï¼ˆè¿™å°±æ˜¯RRçº§åˆ«ä¸‹ï¼Œå¯é‡å¤è¯»çš„å®ç°æ–¹å¼ï¼Œæ¯”å¦‚ï¼Œ`mysqldump --single-transaction`æ—¶ï¼Œå°±æ˜¯åŸºäºRRçº§åˆ«çš„è¯»å¿«ç…§è¿›è¡Œå¯¼å‡ºï¼‰ã€‚

å¦å¤–ï¼Œè¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„è¡¨é”ï¼šAuto-Inc Lockï¼Œå½“æœ‰AUTO_INCREMENTåˆ—æ—¶ï¼Œæ’å…¥æ•°æ®æ—¶ä¼šæœ‰è¿™ä¸ªé”ï¼Œç”±å‚æ•°**innodb_autoinc_lock_mode**æ§åˆ¶è‡ªå¢é•¿çš„æ§åˆ¶ç®—æ³•ã€‚ç”±äºå¹¶å‘æ’å…¥çš„å­˜åœ¨ï¼Œè‡ªå¢é•¿çš„å€¼æ˜¯ä¸è¿ç»­çš„ï¼›é‚£ä¹ˆï¼Œ**åŸºäºstatementçš„ä¸»ä»å¤åˆ¶å¯èƒ½å‡ºç°é—®é¢˜ï¼›å› æ­¤ï¼Œå¯ç”¨auto_incrementåï¼Œéœ€è¦æ˜¯æœ‰rowæ¨¡å¼çš„ä¸»ä»å¤åˆ¶ã€‚**

### è¡Œé”

åœ¨DMLä¸­ï¼Œä¸€èˆ¬å°±æ˜¯è¡Œé”ï¼Œé»˜è®¤çš„å­˜å‚¨å¼•æ“InnoDBå®ç°çš„å°±æ˜¯è¡Œé”ï¼Œæœ‰X/Sä¸¤ç§æ¨¡å¼ã€‚

- **Record Lock**ï¼šåŸºäºä¸»é”®é”å®šæŸä¸ªè®°å½•

- **Gap Lock**ï¼šè¦æ±‚éš”ç¦»çº§åˆ«æ˜¯RRï¼Œå¹¶ä¸”innodb_locks_unsafe_for_binlog=0ï¼›è¿™æ—¶ï¼Œå¦‚æœæŸ¥è¯¢èµ°éå”¯ä¸€ç´¢å¼•æˆ–è€…æŸ¥è¯¢æ˜¯èŒƒå›´è¯»ï¼Œé‚£ä¹ˆä¼šåŠ GapLockã€‚

  > `innodb_locks_unsafe_for_binlog`
  >
  > è¯¥å‚æ•°çš„ä½œç”¨å’Œå°†éš”ç¦»çº§åˆ«è®¾ç½®ä¸º READ COMMITTEDç›¸åŒï¼Œæ˜¯ä¸€ä¸ªå°†è¦åºŸå¼ƒçš„å‚æ•°ã€‚

- **Next-Key Lock**ï¼šå‰ææ˜¯å¯ç”¨äº†GapLockï¼Œå…¶æ˜¯Record Lockå’Œè¯¥Recordä¹‹å‰åŒºé—´çš„Gap Lockçš„ç»“åˆï¼›å¦åˆ™ï¼Œåªæ˜¯recordLockã€‚

  å½“ç»™ä¸€ä¸ªrecordåŠ x/sé”æ—¶ï¼Œå…¶å®æ˜¯ç»™è¯¥recordåŠ recordlockï¼Œå’Œè¯¥recordä¹‹å‰çš„ä¸€ä¸ªgapåŠ äº†gaplockï¼›å³ç»™ä¸€ä¸ªå·¦å¼€å³é—­çš„åŒºé—´åŠ äº†é”ã€‚é¿å…å¹»è¯»ã€‚

  å½“æŸ¥è¯¢çš„ç´¢å¼•å…·æœ‰å”¯ä¸€æ€§æ—¶ï¼ŒNext-Key Locké™çº§ä¸ºRecord Lockã€‚

- **Insert Intention Lock**ï¼šInsertè¯­å¥çš„ç‰¹æ®Šçš„GapLockï¼›gapé”å­˜åœ¨çš„å”¯ä¸€ç›®çš„æ˜¯é˜²æ­¢æœ‰å…¶ä»–äº‹åŠ¡è¿›è¡Œæ’å…¥ï¼Œä»è€Œé€ æˆå¹»è¯»ã€‚å‡å¦‚åˆ©ç”¨gapé”æ¥ä»£æ›¿æ’å…¥æ„å‘é”ï¼Œé‚£ä¹ˆä¸¤ä¸ªäº‹åŠ¡åˆ™ä¸èƒ½åŒæ—¶å¯¹ä¸€ä¸ªgapè¿›è¡Œæ’å…¥ã€‚å› æ­¤ä¸ºäº†æ›´é«˜çš„å¹¶å‘æ€§æ‰€ä»¥ä½¿ç”¨æ’å…¥æ„å‘gapé”ï¼›æ’å…¥æ„å‘é”çš„ä½¿å¾—insertåŒä¸€ä¸ªé—´éš™çš„ä¸åŒé”®å€¼çš„æŸ¥è¯¢ä¹‹é—´ä¸é˜»å¡ï¼Œæé«˜å¹¶å‘ï¼›ä½†æ˜¯è¿˜æ˜¯ä¼šé˜»å¡updateã€deleteæ“ä½œã€‚

  å½“å¤šä¸ªäº‹åŠ¡åœ¨**åŒä¸€åŒºé—´**ï¼ˆgapï¼‰æ’å…¥**ä½ç½®ä¸åŒ**çš„å¤šæ¡æ•°æ®æ—¶ï¼Œäº‹åŠ¡ä¹‹é—´**ä¸éœ€è¦äº’ç›¸ç­‰å¾…**

ç»¼ä¸Šï¼ŒInnoDBçš„é”çš„ç®€å•æ€»ç»“å¦‚ä¸‹ï¼š

![image-20190712104111800](/image/InnoDB-lock.png)

> **ç›‘æ§è§†å›¾**
>
> ```sql
> select * from information_schema.innodb_trx\G; -- æŸ¥çœ‹å½“å‰çš„äº‹åŠ¡ä¿¡æ¯
> select * from information_schema.innodb_locks\G; --æŸ¥çœ‹å½“å‰çš„é”ä¿¡æ¯
> select * from information_schema.innodb_lock_waits\G; --- æŸ¥çœ‹å½“å‰çš„é”ç­‰å¾…ä¿¡æ¯
> --å¯ä»¥è”è¡¨æŸ¥ï¼ŒæŸ¥æ‰¾è‡ªå·±æƒ³è¦çš„ç»“æœã€‚
> select * from sys.innodb_lock_waits\G; -- æŸ¥çœ‹å½“å‰çš„é”ç­‰å¾…ä¿¡æ¯
> show engine innodb status\G;
> ---è¿˜å¯ä»¥é€šè¿‡å½“å‰æ‰§è¡Œäº†æ‰§è¡Œäº†ä»€ä¹ˆè¯­å¥
> select * from  performance_schema.events_statements_current\G; 
> show full processlist;
> ```

> **æ³¨æ„** åœ¨MySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«RRä¸‹ï¼ŒåŒæ ·æ¯”æ ‡å‡†SQLæ›´åŠ ä¸¥æ ¼ï¼Œå³ï¼Œæ²¡æœ‰å¹»è¯»ï¼›ä½†æ˜¯[æ²¡æœ‰å¹»è¯»æœ‰å¹»å†™](https://blog.pythian.com/understanding-mysql-isolation-levels-repeatable-read/)
>
> - å…¶ä»–äº‹åŠ¡æ›´æ–°äº†æ•°æ®
>
> ```sql
> mysql> start transaction;
> mysql> select * from t;
> +-----+--------+------+---------+------+
> | a   | b      | c    | d       | e    |
> +-----+--------+------+---------+------+
> ...
> | 394 | asdf | asdf | asdf    |  399 |
> | 395 | asdf | asdf | asdf    |  400 |
> | 397 | asdf | asdf | asdfasd |  402 |
> +-----+------+------+---------+------+
> Query OK, 0 rows affected (0.00 sec)
> mysql> select * from t where a = 396;
> Empty set (0.00 sec)
> 
> mysql> update t set b = 'pwrite' where a = 396;
> Query OK, 1 row affected (0.00 sec)
> Rows matched: 1  Changed: 1  Warnings: 0
> 
> mysql> select * from t where a = 396;
> +-----+--------+------+---------+------+
> | a   | b      | c    | d       | e    |
> +-----+--------+------+---------+------+
> | 396 | pwrite | asdf | asdfasd |  402 |
> +-----+--------+------+---------+------+
> 1 row in set (0.00 sec)
> 
> mysql> commit;
> Query OK, 0 rows affected (0.01 sec)
> ```
>
> åœ¨ç¬¬3è¡ŒæŸ¥è¯¢ä¹‹å‰ï¼Œåœ¨å¦ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œå¦‚ä¸‹æ›´æ–°ï¼š
>
> ```sql
> update t set a = 396 where e = 402;
> ```
>
> - å…¶ä»–äº‹åŠ¡æ’å…¥äº†æ•°æ®
>
> ```sql
> | 395 | asdf       | asdf | asdf    |  400 |
> | 396 | pwrite     | asdf | asdfasd |  402 |
> | 397 | new insert | asdf | s       |  403 |
> | 398 | new insert | s    | s       |  404 |
> +-----+------------+------+---------+------+
> 399 rows in set (0.01 sec)
> 
> mysql> update t set e=405 where a = 399;
> Query OK, 0 rows affected (0.00 sec)
> Rows matched: 1  Changed: 0  Warnings: 0
> 
> mysql> commit;
> Query OK, 0 rows affected (0.00 sec)
> ```
>
> å‘ç°ï¼š
>
> å½“å‰äº‹åŠ¡selectä¸å¯è§ï¼Œå³ï¼Œä¸èƒ½çœ‹åˆ°æ–°äº‹åŠ¡æäº¤çš„æ•°æ®ï¼Œæ»¡è¶³å¯é‡å¤è¯»ï¼›
>
> ä½†æ˜¯å½“å‰äº‹åŠ¡æ‰§è¡Œupdateï¼Œå´èƒ½å¤Ÿæ›´æ–°ï¼›æ›´æ–°ä¹‹åå†selectï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–°å…ƒç»„ï¼Ÿ
>
> å› æ­¤ï¼Œå¯çŸ¥MySQLçš„RRçº§åˆ«çš„å®ç°ï¼Œåœ¨readçš„æ—¶å€™ç¡®å®æ›´åŠ ä¸¥æ ¼æ²¡æœ‰å¹»è¯»äº†ã€‚ä½†æ˜¯ï¼Œäº‹åŠ¡éœ€è¦ä¿®æ”¹çš„æ—¶å€™ï¼Œå¯¹äºå…¶ä»–äº‹åŠ¡æ–°æ’å…¥çš„æ•°æ®ï¼Œæ˜¯ä¸èƒ½çœ‹åˆ°çš„ï¼›å¯¹äºå…¶ä»–äº‹åŠ¡ä¿®æ”¹çš„æ•°æ®æ˜¯å¯ä»¥çœ‹åˆ°äº†çš„ï¼ŒğŸ˜¹è¿˜æœ‰è¿™ç§æ“ä½œã€‚ã€‚ã€‚
>
> å› æ­¤ï¼Œå¯¹äºMySQLçš„RRçº§åˆ«ï¼Œæœ‰å¦‚ä¸‹ç»“è®ºï¼š
>
> 1. å½“åªæ˜¯selectè¯­å¥æ—¶ï¼Œæ˜¯æ²¡æœ‰å¹»è¯»ï¼ˆPhantom Readï¼‰çš„ï¼›æ¯”å¦‚*mysqldump with â€“single-transaction*ã€‚
> 2. å½“äº‹åŠ¡ä¿®æ”¹æ•°æ®äº†ï¼ŒRRçº§åˆ«çš„è¡¨ç°æ˜¯æœ‰æ‰€ä¸åŒï¼›å¯¹äºæ²¡æœ‰ä¿®æ”¹çš„è¡Œï¼Œæ˜¯RRï¼›å¯¹äºä¿®æ”¹çš„è¡Œï¼Œæ˜¯RCã€‚å› ä¸ºï¼ŒSQLæ ‡å‡†ä¸­å¯¹æ­¤æ²¡æœ‰å®šä¹‰ï¼Œé‚£ä¹ˆä¹Ÿä¸èƒ½è¯´è¿åäº†SQLè¯­ä¹‰ã€‚
> 3. å½“äº‹åŠ¡å†™äº†æ–°æ•°æ®æ—¶ï¼Œè¯¥äº‹åŠ¡å°±ä½¿ç”¨å·²ç»æäº¤çš„æ•°æ®ï¼Œè€Œä¸æ˜¯è¯¥äº‹åŠ¡çš„readviewï¼›æ‰€ä»¥ï¼ŒInnoDBçš„äº‹åŠ¡ä¿®æ”¹æ€»æ˜¯åŸºäºæœ€æ–°çš„æäº¤çš„æ•°æ®è¿›è¡Œä¿®æ”¹ã€‚

## éšå¼å†…å­˜é”

å†…å­˜é”çš„å¯¹è±¡æ˜¯buf_pageä¸­çš„pageï¼Œå³`buf_pool->page_hash`ï¼›page_hashæ˜¯`hash_table_t`ç±»å‹çš„hashè¡¨ï¼›å…¶ä¸­çš„sync_objå°±æ˜¯è¯¥hashè¡¨ä¸­çš„å…ƒç´ çš„é”ï¼Œæ”¾åœ¨ä¸€ä¸ªunionç±»å‹ä¸­ï¼Œæœ‰ä¸¤ç§ç±»å‹ï¼šmutexå’Œrw_lockã€‚

åŒºåˆ«äºäº‹åŠ¡é”æ˜¯å’ŒTransactionç›¸å…³çš„å¹¶å‘æ§åˆ¶ï¼Œåœ¨InnoDBçš„å†…å­˜ä¸­ï¼Œè¿˜æœ‰åŸºäºç³»ç»Ÿæä¾›çš„åŸå­æ“ä½œï¼Œå’Œç”¨æˆ·çº¿ç¨‹ç›¸å…³çš„å­˜å¹¶å‘è®¿é—®æœºåˆ¶ã€‚

**mutexï¼ˆsync0sync.hï¼‰**ï¼Œå†…å­˜ç»“æ„çš„ä¸²è¡Œè®¿é—®ï¼Œä¸»è¦ç”¨åœ¨ä¸€äº›å…±äº«çš„æ•°æ®ç»“æ„ä¸Šï¼Œå¦‚ä¸‹ä¾‹å­ï¼š

- Dictionary mutexï¼ˆDictionary header)
- Transaction undo mutexï¼ŒTransaction system headerçš„å¹¶å‘è®¿é—®ï¼Œåœ¨ä¿®æ”¹indexpageå‰ï¼Œåœ¨Transaction systemçš„headerä¸­å†™å…¥ä¸€ä¸ªundo log entryã€‚
- Rollback segment mutexï¼ŒRollback segment headerçš„å¹¶å‘è®¿é—®ï¼Œå½“éœ€è¦åœ¨å›æ»šæ®µä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„undopageæ—¶ï¼Œéœ€è¦ç”³è¯·è¿™ä¸ªmutexã€‚
- lock_sys_wait_mutexï¼šlock timeout data
- lock_sys_mutexï¼šlock_sys_t
- trx_sys_mutexï¼štrx_sys_t
- Thread mutexï¼šåå°çº¿ç¨‹è°ƒåº¦çš„mutex
- query_thr_mutexï¼šä¿æŠ¤æŸ¥è¯¢çº¿ç¨‹çš„æ›´æ”¹
- trx_mutexï¼štrx_t
- Search system mutex
- Buffer pool mutex
- Log mutex
- Memory pool mutex 

**rw_lockï¼ˆsync0rw.hï¼‰**ï¼Œè¯»å†™æ“ä½œçš„å¹¶å‘è®¿é—®ï¼Œå…¶ä¸­æœ‰ä¸¤ç§é”ç²’åº¦ï¼šindexå’Œblockã€‚æœ‰ä¸‰ç§åŠ›åº¦ï¼šSï¼ŒXï¼ŒSXï¼ˆ5.7æ–°åŠ çš„ï¼‰ã€‚ä¸»è¦ç”¨åœ¨å¦‚ä¸‹äº›åœºæ™¯ä¸­ï¼š

- Secondary index tree latch ï¼ŒSecondary index non-leaf å’Œ leafçš„è¯»å†™
- Clustered index tree latchï¼ŒClustered index non-leaf å’Œ leafçš„è¯»å†™
- Purge system latchï¼ŒUndo log pagesçš„è¯»å†™ï¼Œ
- Filespace management latchï¼Œfile pageçš„è¯»å†™
- ç­‰ç­‰

### rw_lock

åœ¨MySQLä¸­ä¸»è¦å°±æ˜¯é’ˆå¯¹Btreeçš„å¹¶å‘è®¿é—®ï¼Œè¿™é‡Œç®€å•è®¨è®ºä¸€ä¸‹rw_lockåœ¨Btreeè¯»å†™ä¸­çš„æ“ä½œï¼Œï¼ˆæ›´è¯¦ç»†çš„ç»†èŠ‚ï¼Œå¦å¤–ä¸€ç¯‡æ–‡ç« è¿›è¡Œå±•å¼€ï¼‰ï¼š

+ å¯¹äºè¯»æ“ä½œï¼Œåœ¨Indexä¸ŠåŠ s_latchï¼Œåœ¨å®šä½çš„blockä¸ŠåŠ s_latchã€‚

+ å¦‚æœæ˜¯å†™æ“ä½œï¼Œåœ¨5.7ä¹‹åï¼Œåœ¨indexä¸ŠåŠ SXå³å¯ï¼Œåœ¨éœ€è¦ä¿®æ”¹çš„pageä¸ŠåŠ Xã€‚

rw_lockåŸºäºå¦‚ä¸‹ç»“æ„å®ç°çš„è‡ªæ—‹é”ã€‚å¤šä¸ªreadthreadå¯ä»¥æŒæœ‰ä¸€ä¸ªsæ¨¡å¼çš„rw_lockã€‚ä½†æ˜¯ï¼Œxæ¨¡å¼çš„rw_lockåªèƒ½è¢«ä¸€ä¸ªwritethreadæŒæœ‰ï¼›ä¸ºäº†é¿å…writethreadè¢«å¤šä¸ªreadthreadé¥¿æ­»ï¼Œwritethreadå¯ä»¥é€šè¿‡æ’é˜Ÿçš„æ–¹å¼é˜»å¡æ–°çš„readthreadï¼Œæ¯æ’é˜Ÿä¸€ä¸ªwritethreadå°†lockwordå‡X_LOCK_DECRï¼ˆæ–°çš„SXé”ç­‰å¾…æ—¶ï¼Œå‡X_LOCK_HALF_DECRï¼‰

>  åœ¨[wl6363](https://dev.mysql.com/worklog/task/?id=6363)ä¸­ï¼Œæ ‡æ˜äº†åŠ äº†SXé”ålock_wordä¸åŒå–å€¼çš„æ„æ€ï¼›å…¶ä¸­lock_word=0è¡¨ç¤ºåŠ äº†xlockï¼›lock_word= 0x20000000æ²¡æœ‰åŠ é”ï¼›

åœ¨5.7ä¸­ï¼Œrw_lockå…±æœ‰å››ç§ç±»å‹ï¼Œï¼ˆåœ¨5.7æ–°åŠ äº†ä¸€ä¸ª[SX](https://dev.mysql.com/worklog/task/?id=6363)ç±»å‹ï¼‰ã€‚

```c
enum rw_lock_type_t {
	RW_S_LATCH = 1,
	RW_X_LATCH = 2,
	RW_SX_LATCH = 4,
	RW_NO_LATCH = 8
};
/*
 LOCK COMPATIBILITY MATRIX
    S SX  X
 S  +  +  -
 SX +  -  -
 X  -  -  -
 */
```

è¿™ä¸ªæ–°åŠ çš„SXé”ï¼Œä»åŠŸèƒ½ä¸Šå¯ä»¥ç”±ä¸€ä¸ªSé”åŠ ä¸€ä¸ªXé”ä»£æ›¿ã€‚ä½†æ˜¯è¿™æ ·éœ€è¦é¢å¤–çš„åŸå­æ“ä½œï¼Œå› æ­¤å°†ä¸¤ä¸ªæ•´ä¸ªä¸ºä¸€ä¸ªSXé”ã€‚å½“æŒæœ‰SXé”æ—¶ï¼Œç”³è¯·Xé”éœ€è¦'x-lock;sx-unlock;'ã€‚å½“æŒæœ‰Xé”æ—¶ï¼ŒXé”ä¹Ÿå¯é™çº§ä¸ºSXé”ï¼Œè€Œä¸éœ€è¦'sx-lockï¼›x-unlock'ï¼›ã€‚

åœ¨å¯¹Btreeæ“ä½œæ—¶ï¼Œé’ˆå¯¹å¦‚ä¸‹Btreeçš„ä¸åŒæ“ä½œï¼Œå¯¹Btreeçš„Index(å†…å­˜dict_cacheä¸­çš„dict_index_tç»“æ„)æˆ–è€…Page(buf_pool->page)åŠ ä¸åŒæ¨¡å¼çš„rw_lockã€‚

Btreeæœ‰å¦‚ä¸‹çš„åŸºæœ¬æ“ä½œæ¨¡å¼ï¼Œä½œä¸ºbtr_cur_search_to_nth_levelçš„å‚æ•°latch_modeï¼ˆæ— ç¬¦å·32ä½æ•´å‹ï¼‰çš„ä½å­—èŠ‚ï¼›è€Œé«˜å­—èŠ‚æ”¾ä¸€äº›æ ‡è®°ä½ã€‚btr_cur_search_to_nth_levelåŸºæœ¬å°±æ˜¯ä½œä¸ºä»»ä½•Btreeçš„æ“ä½œå®šä½cursorçš„å…¥å£ï¼Œå¯ä»¥çš„è¯å¯¹å®šä½çš„pageè¿›è¡ŒåŠ é”ï¼ˆå–å†³äºlatch_modeï¼‰ã€‚

```c
/** Latching modes for btr_cur_search_to_nth_level(). */
enum btr_latch_mode {
	/** Search a record on a leaf page and S-latch it. */
	BTR_SEARCH_LEAF = RW_S_LATCH,
	/** (Prepare to) modify a record on a leaf page and X-latch it. */
	BTR_MODIFY_LEAF	= RW_X_LATCH,
	/** Obtain no latches. */
	BTR_NO_LATCHES = RW_NO_LATCH,
	/** Start modifying the entire B-tree. */
	BTR_MODIFY_TREE = 33,
	/** Continue modifying the entire B-tree. */
	BTR_CONT_MODIFY_TREE = 34,
	/** Search the previous record. */
	BTR_SEARCH_PREV = 35,
	/** Modify the previous record. */
	BTR_MODIFY_PREV = 36,
	/** Start searching the entire B-tree. */
	BTR_SEARCH_TREE = 37,
	/** Continue searching the entire B-tree. */
	BTR_CONT_SEARCH_TREE = 38
};
```

# å‚è€ƒæ–‡ç« 

[Undoæ¼«æ¸¸]([http://mysql.taobao.org/monthly/2015/04/01/](http://mysql.taobao.org/monthly/2015/04/01/))

[binlogæ–‡æ¡£](https://dev.mysql.com/doc/internals/en/binary-log-overview.html)

[worklog-mysql-5223](https://dev.mysql.com/worklog/task/?id=5223)

[binlog-group-commit]([http://mysqlmusings.blogspot.com/2012/06/binary-log-group-commit-in-mysql-56.html](http://mysqlmusings.blogspot.com/2012/06/binary-log-group-commit-in-mysql-56.html))











