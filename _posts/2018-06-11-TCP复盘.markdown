---
layout: post
title: å›é¡¾TCP
date: 2018-06-11 16:30
header-img: "img/head.jpg"
categories: jekyll update
tags:
  - Network
typora-root-url: ../../yummmyliu.github.io
---

* TOC
{:toc}
# TCP çŠ¶æ€

TCPæ€»å…±æœ‰11ä¸­çŠ¶æ€ï¼š

- CLOSEDï¼šæ— é“¾æ¥çš„çŠ¶æ€ã€‚

- LISTENï¼šserverç­‰å¾…clienté“¾æ¥çš„çŠ¶æ€ã€‚

- SYN-SENTï¼šä¸‰æ¬¡æ¡æ‰‹çš„ç¬¬ä¸€æ­¥ï¼Œclientå‘é€ä¸€ä¸ªé“¾æ¥è¯·æ±‚åçš„çŠ¶æ€ã€‚

- SYN-RECEIVEDï¼šä¸‰æ¬¡æ¡æ‰‹çš„ç¬¬äºŒæ­¥ï¼Œclientæ”¶åˆ°äº†é“¾æ¥è¯·æ±‚çš„ACKåçš„çŠ¶æ€ã€‚

- ESTABLISHEDï¼šä¸‰æ¬¡æ¡æ‰‹çš„ç¬¬ä¸‰æ­¥ï¼Œé“¾æ¥æœ€ç»ˆæ‰“å¼€äº†çš„çŠ¶æ€ã€‚

  > åœ¨å…³é—­æ—¶ï¼Œä¸¤æ®µæ˜¯ç›¸åŒçš„ã€‚è¿™é‡Œè®²å‘èµ·å…³é—­çš„ä¸€ç«¯ç§°ä¸ºï¼šæœ¬ç«¯ã€‚å¦ä¸€ä¸ªå«ï¼šè¿œç«¯ã€‚

- FIN-WAIT-1ï¼šå››æ¬¡æŒ¥æ‰‹çš„ç¬¬ä¸€æ­¥ï¼Œæœ¬ç«¯å‘é€äº†ä¸€ä¸ªç»ˆæ­¢é“¾æ¥çš„è¯·æ±‚ï¼ˆ**FIN**ï¼‰åçš„çŠ¶æ€ã€‚

- CLOSE-WAITï¼šè¿œç«¯æ”¶åˆ°ä¸€ä¸ªç»ˆæ­¢é“¾æ¥çš„è¯·æ±‚ï¼Œå¹¶ä¸”å›å¤äº†ACKåçš„çŠ¶æ€ã€‚æ¯”å¦‚ï¼Œæœ¬ç«¯ä¸»åŠ¨å…³é—­é“¾æ¥è€Œè¿œç«¯è¢«åŠ¨å…³é—­é“¾æ¥æ—¶ï¼Œè¿œç«¯è¿˜éœ€è¦ä¸»åŠ¨çš„`close()`ï¼Œä»è€Œç¦»å¼€è¿™ä¸ªçŠ¶æ€ï¼Œè‹¥ä»£ç ä¸­clientç«¯æ²¡æœ‰ä¸»åŠ¨å…³é—­ï¼Œå¯èƒ½æœ‰bugã€‚

- FIN-WAIT-2ï¼šæœ¬ç«¯**åœ¨FIN-WAIT-1**çŠ¶æ€åï¼Œå¦‚æœ**åªæ”¶åˆ°äº†**è¿œç«¯çš„å¯¹äºå…³é—­è¯·æ±‚çš„ACKåï¼Œæœ¬ç«¯ç­‰å¾…è¿œç«¯çš„ä¸€ä¸ªä¸‹ä¸€ä¸ª**ä¸»åŠ¨å…³é—­ FIN**çš„è¯·æ±‚ã€‚

- LAST-ACKï¼šè¿œç«¯è¿Ÿè¿Ÿæ²¡æœ‰ä¸»åŠ¨å…³é—­ï¼Œä¸€æ®µæ—¶é—´åï¼Œå°±ä¼šè¢«åŠ¨å…³é—­å¹¶å‘è¿œç«¯å‘é€ä¸€ä¸ª**ä¸»åŠ¨å…³é—­ FIN**çš„è¯·æ±‚ã€‚

- CLOSINGï¼šæœ¬ç«¯**åœ¨FIN-WAIT-1**çŠ¶æ€åï¼Œå¦‚æœå…ˆæ”¶åˆ°äº†è¿œç«¯çš„**ä¸»åŠ¨å…³é—­ FIN**çš„è¯·æ±‚ï¼Œé‚£ä¹ˆè¿›å…¥è¯¥çŠ¶æ€ï¼ŒåŒæ—¶ç­‰å¾…ACKã€‚

- TIME-WAITï¼šCLOSINGäº†ä¸€æ®µæ—¶é—´åï¼Œè¿˜æ˜¯æ²¡æœ‰æ”¶åˆ°ACKï¼Œè¿›å…¥è¯¥çŠ¶æ€ã€‚ä¹‹åç­‰äº†2MSLé•¿æ—¶é—´åï¼Œè¿˜æ˜¯æ²¡æ”¶åˆ°ACKï¼Œé‚£ä¹ˆå¯ä»¥ç¡®è®¤å¯¹æ–¹æ”¶åˆ°äº†FINï¼Œæœ€ç»ˆå…³é—­ã€‚

## çŠ¶æ€è½¬æ¢å›¾

ä»ç½‘ä¸Šæ‘˜äº†ä¸ªå›¾ï¼š

![](/../yummyliu.github.io/image/tcp.gif)

# TCPè¿æ¥å»ºç«‹ä¸æ–­å¼€

## ä¸‰æ¬¡æ¡æ‰‹ğŸ¤ï¼š

### æµç¨‹

å¯¹äºæ¯ä¸ªå¤„äº**LISTENING**çŠ¶æ€çš„Socketï¼Œéƒ½æœ‰ä¸¤ä¸ªQueueï¼ˆä¹Ÿå«backlogï¼Œç§¯å‹ï¼‰ï¼š

+ SYN Queue
+ Accept Queue

å½“clientå‘èµ·è¿æ¥æ—¶ï¼Œæœ‰å¦‚ä¸‹ä¸‰æ­¥ï¼š

1. clientå‘é€**SYN**ã€‚
2. serveræ¥æ”¶**SYN**ï¼Œæ”¾å…¥`SYN QUEUE`ä¸­ï¼›ç»™clientè¿”å› **SYN+ACK**ã€‚
3. clientå‘é€**ACK**ï¼›

serveræ”¶åˆ°ACKåï¼Œå…ˆå’ŒESTABLISHEDçš„è¿æ¥å¯¹æ¯”ï¼Œç„¶åå’Œ`SYN QUEUE`ä¸­çš„å¯¹æ¯”ï¼›å¯¹æ¯”æˆåŠŸï¼Œsyn queueä¸­çš„slotåˆ æ‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„inet_sockï¼Œæ”¾åˆ°ACCEPT QUEUEé˜Ÿåˆ—ä¸­ï¼›**è¿æ¥å»ºç«‹æˆåŠŸ**ã€‚å½“applicationè°ƒç”¨acceptçš„æ—¶å€™ï¼Œç›¸åº”çš„socketså‡ºåˆ—ï¼Œèµ‹äºˆç»™application

![img](/../yummyliu.github.io/image/all-1.png)

ä»¥ä¸Šå°±æ˜¯é€šå¸¸çš„ä¸‰æ¬¡æ¡æ‰‹ï¼›ä½†æ˜¯å¦‚æœè®¾ç½®äº†`TCP_FASTOPEN`å’Œ`TCP_DEFER_ACCEPT`å°±æœ‰ç‚¹ä¸ä¸€æ ·

### å‡ ä¸ªå‚æ•°

#### TCP_FASTOPEN

é»˜è®¤ç³»ç»Ÿå…³é—­fastopenï¼›ä¸€èˆ¬TCPçš„CSä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```c
/*************************************
	client 
*************************************/
/* create socket file descriptor */
fd = socket(domain, type, protocol);
/* connect to the target server/port */
connect(fd,...);
/* send some data */
send(fd, buf, size);
/* wait for some reply and read into a local buffer */ 
while ((bytes  = recv(fd, ...))) {
    ...
}

/*************************************
	server 
*************************************/
/* create the socket */
fd = socket();
/* connect and send out some data */
bind(fd, addr, addrlen);
/* this socket will listen for incoming connections */
listen(fd, backlog);
```

åŠ äº†FASTOPENå‚æ•°`echo 1 > /proc/sys/net/ipv4/tcp_fastopen`åï¼Œé€šè¿‡tcpçš„cookieï¼Œèƒ½å¤ŸåŠ å¿«è¿æ¥æ‰“å¼€çš„é€Ÿåº¦ã€‚

```c
/*************************************
	client 
*************************************/
/* create the socket */
fd = socket();
/* connect and send out some data */
sendto(fd, buffer, buf_len, MSG_FASTOPEN, ...);
/* write more data */
send(fd, buf, size);
/* wait for some reply and read into a local buffer */ 
while ((bytes  = recv(fd, ...))) {
    ...
}
/*************************************
	server 
*************************************/
/* 
 * A generic protection in case you include this 
 * from multiple files 
 */
#ifndef _KERNEL_FASTOPEN
#define _KERNEL_FASTOPEN
/* conditional define for TCP_FASTOPEN */
#ifndef TCP_FASTOPEN
#define TCP_FASTOPEN   23
#endif
/* conditional define for MSG_FASTOPEN */
#ifndef MSG_FASTOPEN
#define MSG_FASTOPEN   0x20000000
#endif
#endif

/* a hint value for the Kernel */
int qlen = 5;
/* create the socket */
fd = socket();
/* bind the address */
bind(fd, addr, addrlen);
/* change the socket options to TCO_FASTOPEN */
setsockopt(sockfd, SOL_TCP, TCP_FASTOPEN, &qlen, sizeof(qlen));
/* this socket will listen for incoming connections */
listen(fd, backlog);
```

#### TCP_DEFER_ACCEPT

ä¸‰æ¬¡æ¡æ‰‹çš„ç¬¬äºŒæ­¥ä¹‹åï¼Œserveréœ€è¦ç­‰å¾…ä¸€ä¸ªackï¼Œæ‰èƒ½å»ºç«‹è¿æ¥ï¼›è€Œä¹‹åæ‰ä¼šæœ‰å®é™…æ•°æ®ï¼›è¿™åœ¨å»ºç«‹tcpè¿æ¥çš„æ—¶å€™ï¼Œæ¯”è¾ƒè€—æ—¶ï¼›æ‰“å¼€äº†TCP_DEFER_ACCEPTä¹‹åï¼Œserveråœ¨æ¥æ”¶åˆ°SYN+ACKåŒ…ä¹‹åï¼Œä¸ä¼šç­‰å¾…ackï¼Œç›´æ¥ç­‰å¾…å®é™…æ•°æ®åŒ…ï¼›è¿™èƒ½å‡å°‘è¿æ¥å»ºç«‹æ—¶çš„å»¶è¿Ÿã€‚

#### AF_INET vs AF_UNIX

åˆ†åˆ«ä»£è¡¨ä½¿ç”¨çš„äº‹Unix Socketè¿˜æ˜¯IP Socketã€‚UnixSocketæ˜¯ä¸€ç§æœ¬æœºå†…çš„IPCæ–¹å¼ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ï¼Œæ‹¥æœ‰inodeä»¥åŠæƒé™ç­‰ä¿¡æ¯ï¼Œä½†æ˜¯æ˜¯é€šè¿‡recvå’Œsendæ¥è¯»å†™ã€‚å½“bindåˆ°UnixSocketä¸Šæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ–‡ä»¶è·¯å¾„çš„æ–¹å¼æ¥è¿æ¥è€Œä¸æ˜¯ip:portå¯¹ã€‚

å¯¹äºUnixSocketï¼Œå…¶æ•°æ®åŒ…å…å»åŒ…å¤´éƒ¨åˆ†çš„ä¿¡æ¯ï¼Œè¿›è€Œå‡å°‘äº†ç½‘ç»œæ ˆä¸­çš„æ•°æ®å°è£…ä¸å‰¥ç¦»çš„è¿‡ç¨‹ï¼›å¦å¤–ï¼Œä¹Ÿå°‘äº†è·¯ç”±çš„ä»£ä»·ï¼Œä»è€Œæ¯”èµ·127.0.0.1çš„æ€§èƒ½æ›´åŠ ä¼˜ç§€ã€‚

## å››æ¬¡æŒ¥æ‰‹ğŸ‘‹

### æµç¨‹

åœ¨Linuxä¸­ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼ŒSocketä¹Ÿä¸ä¾‹å¤–ï¼›ä¸€ä¸ªæˆåŠŸå»ºç«‹çš„Socketæ–‡ä»¶ï¼Œæ˜¯ç”±ä¸¤å¯¹**<IPï¼ŒPort>**ç¡®å®šçš„ï¼›å½“å…¶ä¸­ä¸€æ–¹TCP Closeçš„æ—¶å€™ï¼Œå°±å¼€å§‹äº†è¿™ä¸ªSocketçš„å››æ¬¡æŒ¥æ‰‹çš„å…³é—­æµç¨‹ï¼Œå¦‚ä¸‹ï¼Œæ‘˜è‡ªWikipediaï¼š

```
     TCP A                                                TCP B

  0.  ESTABLISHED                                          ESTABLISHED

  1.  (Close)
      FIN-WAIT-1  --> <SEQ=100><ACK=300><CTL=FIN,ACK>  --> CLOSE-WAIT

  2.  FIN-WAIT-2  <-- <SEQ=300><ACK=101><CTL=ACK>      <-- CLOSE-WAIT

  3.                                                       (Close)
      TIME-WAIT   <-- <SEQ=300><ACK=101><CTL=FIN,ACK>  <-- LAST-ACK

  4.  TIME-WAIT   --> <SEQ=101><ACK=301><CTL=ACK>      --> CLOSED

  5.  (2 MSL)
      CLOSED       
```

1. å‘èµ·Closeçš„ä¸€ç«¯Aï¼Œæ„å‘³ç€æˆ‘æ²¡æœ‰ä»»ä½•æ•°æ®éœ€è¦å‘é€äº†ï¼Œä½†æ˜¯ä¹‹åè¿˜æ˜¯ä¼šæ¥æ”¶æ•°æ®ï¼Œç›´åˆ°è¢«é€šçŸ¥å¦ä¸€ç«¯ä¹ŸCloseäº†ï¼›

2. Bæ”¶åˆ°FINä¿¡å·ï¼Œè¿›å…¥CLOSE_WAITçŠ¶æ€ï¼Œå¹¶å›å¤ACKï¼›TCPæ˜¯å¯é çš„ï¼Œæ­¤æ—¶Bä¼šä¿è¯åœ¨Bå…³é—­ä¹‹å‰å°†Bufferä¸­çš„æ•°æ®å‘é€å‡ºå»ã€‚*è¿™é‡Œè¦ç¡®ä¿è‡ªå·±ä¼šåŠæ—¶å…³é—­ï¼ˆ60sä¹‹å†…ï¼‰è¿™äº›CLOSE_WAITçŠ¶æ€çš„socketï¼Œå¦åˆ™ä¼šsocketæ³„éœ²*ï¼›

   > å¦‚ä¸‹çš„CLOSE_WAITå°±è¡¨ç¤ºecho è¿›ç¨‹æ²¡æœ‰ä¸»åŠ¨å…³é—­è¿æ¥
   >
   > [liuyangming@ymtest ~]$ netstat -nalp | grep tcp | grep 8081
   > (Not all processes could be identified, non-owned process info
   >  will not be shown, you would have to be root to see it all.)
   > tcp        0      0 0.0.0.0:8081                0.0.0.0:*                   LISTEN      50092/./echo
   > tcp        0      0 127.0.0.1:59274             127.0.0.1:8081              FIN_WAIT2   -
   > tcp        1      0 127.0.0.1:8081              127.0.0.1:59274             CLOSE_WAIT  50092/./echo

3. Aæ”¶åˆ°äº†Bçš„ä¸»åŠ¨å…³é—­çš„ä¸€ä¸ªFINä¿¡å·ï¼Œä¹Ÿä¼šå›å¤ä¸€ä¸ªACKï¼›

4. å½“ä¸¤ç«¯éƒ½æ”¶åˆ°å¯¹æ–¹çš„ACKæˆ–è€…è¶…æ—¶ç¡®è®¤å¯¹æ–¹è‚¯å®šæ”¶åˆ°äº†ACKåï¼Œä¸¤ç«¯å…³é—­è¿æ¥ã€‚

> åœ¨åŸæ¥çš„TCPåè®®ä¸­ï¼Œæ˜¯ä¸å…è®¸ä»FIN_WAIT_2çŠ¶æ€è‡ªåŠ¨è½¬æ¢çš„ï¼›FIN_WAIT_2åº”è¯¥æ¥ç€è¿è¡Œï¼Œç›´åˆ°å¦ä¸€ç«¯å·²ç»æ¸…ç†å®Œæ¯•äº†ã€‚ä½†æ˜¯å®é™…ä¸Šç»è¿‡`tcp_fin_timeout`æ—¶é—´ï¼Œå¦‚æœæ”¶ä¸åˆ°å¦ä¸€ç«¯çš„finæ§åˆ¶ä¿¡å·ï¼Œä¼šå¼ºåˆ¶å…³é—­è‡ªå·±ï¼Œä¸ºäº†é˜²æ­¢dosæ”»å‡»ï¼›
>
> ```
> tcp_fin_timeout (integer; default: 60)
>       This specifies how many seconds to wait for a final FIN packet
>       before the socket is forcibly closed.  This is strictly a
>       violation of the TCP specification, but required to prevent
>       denial-of-service attacks.
> ```

### å‡ ä¸ªå‚æ•°

#### SO_REUSEADDR

è¿æ¥å…³é—­åï¼Œä¼šåœ¨ä¼šåœ¨**TIME_WAIT** é˜¶æ®µç­‰å¾…ä¸€ä¼šï¼Œè¿™ä¸ªå‚æ•°å…è®¸é‡ç”¨**TIME_WAIT**çš„åœ°å€ã€‚

æ³¨æ„TIME_WAITçŠ¶æ€æ°¸è¿œå‡ºç°åœ¨ä¸»åŠ¨å‘èµ·å…³é—­çš„ä¸€ç«¯ï¼ŒCLOSE_WAITçŠ¶æ€æ°¸è¿œå‡ºç°åœ¨è¢«åŠ¨å…³é—­è¿æ¥çš„ä¸€ç«¯ã€‚

## å‚è€ƒæ–‡çŒ®

[syn-packet-handling-in-the-wild](https://blog.cloudflare.com/syn-packet-handling-in-the-wild/)