---
layout: post
title: ÂõûÈ°æTCP
date: 2018-06-11 16:30
header-img: "img/head.jpg"
categories: jekyll update
tags:
  - Network
typora-root-url: ../../yummmyliu.github.io
---

* TOC
{:toc}


**Âõæ1 TCP Áä∂ÊÄÅËΩ¨Êç¢Âõæ**

![](/../yummyliu.github.io/image/tcp.gif)

### 3Ê¨°Êè°Êâãü§ùÔºö

1. ## clientÂèëÈÄÅSYNÔºåËØ∑Ê±ÇËøûÊé•

2. serverÊé•Êî∂SYNÔºåÊîæÂÖ•SYN QUEUE‰∏≠ÔºõÁªôclientËøîÂõû SYN+ACK

3. clientÂèëÈÄÅACKÔºåÂÖàÂíåESTABLISHEDÁöÑËøûÊé•ÂØπÊØîÔºåÁÑ∂ÂêéÂíåsyn queue‰∏≠ÁöÑÂØπÊØîÔºõÂØπÊØîÊàêÂäüÔºåsyn queue‰∏≠ÁöÑslotÂà†ÊéâÔºåÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑinet_sockÔºåÊîæÂà∞ACCEPT QUEUEÈòüÂàó‰∏≠Ôºõ**ËøûÊé•Âª∫Á´ãÊàêÂäü**

4. ÂΩìapplicationË∞ÉÁî®acceptÁöÑÊó∂ÂÄôÔºåÁõ∏Â∫îÁöÑsocketsÂá∫ÂàóÔºåËµã‰∫àÁªôapplication

   ![](/image/all-1.jpeg)

   ËøôÂ∞±ÊòØÈÄöÂ∏∏ÁöÑ‰∏âÊ¨°Êè°ÊâãÔºõ‰ΩÜÊòØÂ¶ÇÊûúËÆæÁΩÆ‰∫Ü`TCP_FASTOPEN`Âíå`TCP_DEFER_ACCEPT`Â∞±ÊúâÁÇπ‰∏ç‰∏ÄÊ†∑

##### TCP_FASTOPEN

###### client normal

```c
/* create socket file descriptor */
fd = socket(domain, type, protocol);

/* connect to the target server/port */
connect(fd,...);

/* send some data */
send(fd, buf, size);

/* wait for some reply and read into a local buffer */ 
while ((bytes  = recv(fd, ...))) {
    ...
}
```

###### client fastopen

```c
/* create the socket */
fd = socket();

/* connect and send out some data */
sendto(fd, buffer, buf_len, MSG_FASTOPEN, ...);

/* write more data */
send(fd, buf, size);

/* wait for some reply and read into a local buffer */ 
while ((bytes  = recv(fd, ...))) {
    ...
}
```

###### server normal

```c
/* create the socket */
fd = socket();

/* connect and send out some data */
bind(fd, addr, addrlen);

/* this socket will listen for incoming connections */
listen(fd, backlog);
```

server fastopen

```c
/* 
 * A generic protection in case you include this 
 * from multiple files 
 */
#ifndef _KERNEL_FASTOPEN
#define _KERNEL_FASTOPEN

/* conditional define for TCP_FASTOPEN */
#ifndef TCP_FASTOPEN
#define TCP_FASTOPEN   23
#endif

/* conditional define for MSG_FASTOPEN */
#ifndef MSG_FASTOPEN
#define MSG_FASTOPEN   0x20000000
#endif

#endif

/* a hint value for the Kernel */
int qlen = 5;

/* create the socket */
fd = socket();

/* bind the address */
bind(fd, addr, addrlen);

/* change the socket options to TCO_FASTOPEN */
setsockopt(sockfd, SOL_TCP, TCP_FASTOPEN, &qlen, sizeof(qlen));

/* this socket will listen for incoming connections */
listen(fd, backlog);
```

ÈªòËÆ§Á≥ªÁªüÂÖ≥Èó≠fastopenÔºõ

ÊâìÂºÄÔºö`echo 1 > /proc/sys/net/ipv4/tcp_fastopen`

##### TCP_DEFER_ACCEPT

‰∏âÊ¨°Êè°ÊâãÁöÑÁ¨¨‰∫åÊ≠•‰πãÂêéÔºåserverÈúÄË¶ÅÁ≠âÂæÖ‰∏Ä‰∏™ackÔºåÊâçËÉΩÂª∫Á´ãËøûÊé•ÔºõËÄå‰πãÂêéÊâç‰ºöÊúâreal dataÔºõËøôÂú®Âª∫Á´ãtcpËøûÊé•ÁöÑÊó∂ÂÄôÔºåÊØîËæÉËÄóÊó∂Ôºõ

ÊâìÂºÄ‰∫ÜTCP_DEFER_ACCEPT‰πãÂêéÔºåserverÂú®Êé•Êî∂Âà∞SYN+ACKÂåÖ‰πãÂêéÔºå‰∏ç‰ºöÁ≠âÂæÖackÔºåÁõ¥Êé•Á≠âÂæÖreal dataÂåÖÔºõËøôËÉΩÂáèÂ∞ëËøûÊé•Âª∫Á´ãÊó∂ÁöÑdelayÔºõ

### ÂõõÊ¨°Êå•Êâãüëã

Âú®Linux‰∏≠Ôºå‰∏ÄÂàáÁöÜÊñá‰ª∂ÔºåSocket‰πü‰∏ç‰æãÂ§ñÔºõ‰∏Ä‰∏™ÊàêÂäüÂª∫Á´ãÁöÑSocketÊñá‰ª∂ÔºåÊòØÁî±‰∏§ÂØπIP:PortÁ°ÆÂÆöÁöÑÔºõÂΩìÂÖ∂‰∏≠‰∏ÄÊñπTCP CloseÁöÑÊó∂ÂÄôÔºåÂ∞±ÂºÄÂßã‰∫ÜËøô‰∏™SocketÁöÑÂõõÊ¨°Êå•ÊâãÁöÑÂÖ≥Èó≠ÊµÅÁ®ãÔºåÂ¶Ç‰∏ãÔºö

```
     TCP A                                                TCP B

  0.  ESTABLISHED                                          ESTABLISHED

  1.  (Close)
      FIN-WAIT-1  --> <SEQ=100><ACK=300><CTL=FIN,ACK>  --> CLOSE-WAIT

  2.  FIN-WAIT-2  <-- <SEQ=300><ACK=101><CTL=ACK>      <-- CLOSE-WAIT

  3.                                                       (Close)
      TIME-WAIT   <-- <SEQ=300><ACK=101><CTL=FIN,ACK>  <-- LAST-ACK

  4.  TIME-WAIT   --> <SEQ=101><ACK=301><CTL=ACK>      --> CLOSED

  5.  (2 MSL)
      CLOSED       
```

üëãÔºöÂèëËµ∑CloseÁöÑ‰∏ÄÁ´ØAÔºåÊÑèÂë≥ÁùÄÊàëÊ≤°Êúâ‰ªª‰ΩïÊï∞ÊçÆÈúÄË¶ÅSEND‰∫ÜÔºå‰ΩÜÊòØÂú®ÂèëËµ∑Close‰πãÂêéËøòÊòØ‰ºöRecvÔºåÁõ¥Âà∞Ë¢´ÈÄöÁü•Âè¶‰∏ÄÁ´Ø‰πüClose‰∫ÜÔºõ

üëãüëãÔºöBÊî∂Âà∞FIN‰ø°Âè∑ÔºåËøõÂÖ•CLOSE_WAITÁä∂ÊÄÅÔºåÂπ∂ÂõûÂ§çACKÔºõTCPÊòØÂèØÈù†ÁöÑÔºåÊ≠§Êó∂B‰ºö‰øùËØÅÂ∞ÜBuffer‰∏≠ÁöÑÊï∞ÊçÆÔºåÂú®BÂÖ≥Èó≠‰πãÂâçÂèëÈÄÅÂá∫ÂéªÔºå*ËøôÈáåË¶ÅÁ°Æ‰øùËá™Â∑±‰ºöÂèäÊó∂ÂÖ≥Èó≠Ôºà60s‰πãÂÜÖÔºâËøô‰∫õCLOSE_WAITÁä∂ÊÄÅÁöÑsocketÔºåÂê¶Âàô‰ºösocketÊ≥ÑÈú≤*Ôºõ

üëãüëãüëãÔºöTCPÊî∂Âà∞‰∏Ä‰∏™FIN‰ø°Âè∑Ôºå‰ºöÂõûÂ§ç‰∏Ä‰∏™ACKÔºõ‰ΩÜÊòØ‰∏ç‰ºöÁ´ãÈ©¨ÂèëÈÄÅËá™Â∑±ÁöÑFIN‰ø°Âè∑ÔºåÁõ¥Âà∞Ëá™Ë∫´ÁöÑuser‰πüCloseËøô‰∏™tcpËøûÊé•Ôºõ

üëãüëãüëãüëãÔºöBÁ´Ø‰∏ªÂä®ÂèëËµ∑CloseÔºåÁªôAÂèë‰∏Ä‰∏™FINÔºå‰∏ÄËµ∑ÂÖ≥Èó≠

> Âú®ÂéüÊù•ÁöÑTCPÂçèËÆÆ‰∏≠ÔºåÊòØ‰∏çÂÖÅËÆ∏‰ªéFIN_WAIT_2Áä∂ÊÄÅËá™Âä®ËΩ¨Êç¢ÁöÑÔºõFIN_WAIT_2Â∫îËØ•Êé•ÁùÄËøêË°åÔºåÁõ¥Âà∞Âè¶‰∏ÄÁ´ØÂ∑≤ÁªèÊ∏ÖÁêÜÂÆåÊØï‰∫Ü„ÄÇ‰ΩÜÊòØÂÆûÈôÖ‰∏äÁªèËøá`tcp_fin_timeout`Êó∂Èó¥ÔºåÂ¶ÇÊûúÊî∂‰∏çÂà∞Âè¶‰∏ÄÁ´ØÁöÑfinÊéßÂà∂‰ø°Âè∑Ôºå‰ºöÂº∫Âà∂ÂÖ≥Èó≠Ëá™Â∑±Ôºå‰ΩçÁΩÆÊîæÁΩÆdosÊîªÂáªÔºõ
>
> ```
> tcp_fin_timeout (integer; default: 60)
>       This specifies how many seconds to wait for a final FIN packet
>       before the socket is forcibly closed.  This is strictly a
>       violation of the TCP specification, but required to prevent
>       denial-of-service attacks.
> ```

#### SO_REUSEADDR

https://stackoverflow.com/questions/3229860/what-is-the-meaning-of-so-reuseaddr-setsockopt-option-linux

#### TCP_DEFER_ACCEPT || SO_ACCEPTFILTER



## ÂèÇËÄÉÊñáÁåÆ

[ref](https://www.ibm.com/support/knowledgecenter/en/SSLTBW_2.1.0/com.ibm.zos.v2r1.halu101/constatus.htm)

[ref](http://edsiper.linuxchile.cl/blog/2013/02/21/linux-tcp-fastopen-in-your-sockets/)

[ref](https://blog.cloudflare.com/syn-packet-handling-in-the-wild/)

[ref](https://blog.cloudflare.com/this-is-strictly-a-violation-of-the-tcp-specification/)

[ref](http://www.freesoft.org/CIE/Course/Section4/11.htm)
